<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>G√©n√©rateur de publications</title>
  <style>
    :root{
      --bg:#0b0f12;
      --panel:#0f1720;
      --border:rgba(255,255,255,0.06);
      --muted:#9aa5b1;
      --accent:#7dd3fc;
      --accent-2:#f472b6;
      --text:#e6eef6;
      --success:#4ade80;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1000px;margin:20px auto;padding:24px}
    h1{margin:0 0 20px;font-size:22px;font-weight:600}
    
    .section{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px}
    .section.disabled{opacity:0.5;pointer-events:none}
    .section-title{font-size:14px;font-weight:600;margin-bottom:12px;color:var(--accent)}
    
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:4px;position:relative}
    .field label{font-size:13px;color:var(--muted);font-weight:500}
    .field input,.field textarea,.field select{
      background:var(--bg);
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius:6px;
      color:var(--text);
      font-size:14px;
      font-family:inherit;
    }
    .field input:focus,.field textarea:focus,.field select:focus{
      outline:none;
      border-color:var(--accent);
    }
    .field textarea{resize:vertical;min-height:80px}
    
    .field.custom{border:1px dashed var(--accent-2);padding:8px;border-radius:6px;background:rgba(244,114,182,0.05)}
    .field.custom label{color:var(--accent-2)}
    
    .remove-var{
      position:absolute;
      top:0;
      right:0;
      background:transparent;
      border:none;
      color:var(--accent-2);
      cursor:pointer;
      padding:0;
      width:20px;
      height:20px;
      font-size:16px;
    }
    .remove-var:hover{color:#ff6b9d}
    
    .template-radio-group{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .template-radio-item{position:relative}
    .template-radio-item input[type="radio"]{
      position:absolute;
      opacity:0;
      width:0;
      height:0;
    }
    .template-radio-label{
      display:inline-block;
      background:var(--bg);
      border:2px solid var(--border);
      padding:10px 16px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:all 0.2s;
    }
    .template-radio-item input[type="radio"]:checked + .template-radio-label{
      background:rgba(125,211,252,0.15);
      border-color:var(--accent);
      color:var(--accent);
    }
    .template-radio-label:hover{
      border-color:var(--accent);
      background:rgba(125,211,252,0.08);
    }
    
    .checkbox-group{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .checkbox-group input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
    .checkbox-group label{margin:0;cursor:pointer;font-size:14px}
    
    button{
      background:var(--panel);
      border:1px solid var(--border);
      padding:8px 16px;
      border-radius:6px;
      color:var(--accent);
      font-size:14px;
      cursor:pointer;
      font-weight:500;
      transition:all 0.2s;
    }
    button:hover{background:rgba(125,211,252,0.1);border-color:var(--accent)}
    button:active{transform:scale(0.98)}
    button.success{color:var(--success)}
    button.secondary{color:var(--accent-2)}
    button.danger{color:var(--danger)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    
    .btn-row{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    
    .preview{
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:6px;
      padding:16px;
      font-family:monospace;
      font-size:13px;
      white-space:pre-wrap;
      word-wrap:break-word;
      max-height:400px;
      overflow-y:auto;
      line-height:1.6;
    }
    
    .image-gallery{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .image-preview-item{
      position:relative;
      width:120px;
      height:120px;
      border:2px solid var(--border);
      border-radius:6px;
      overflow:hidden;
      cursor:pointer;
      transition:all 0.2s;
    }
    .image-preview-item:hover{border-color:var(--accent)}
    .image-preview-item.main{border-color:var(--accent);box-shadow:0 0 12px rgba(125,211,252,0.4)}
    .image-preview-item img{width:100%;height:100%;object-fit:cover}
    .image-preview-badge{
      position:absolute;
      top:4px;
      left:4px;
      background:var(--accent);
      color:var(--bg);
      padding:2px 6px;
      border-radius:4px;
      font-size:10px;
      font-weight:600;
    }
    .image-preview-remove{
      position:absolute;
      top:4px;
      right:4px;
      background:rgba(239,68,68,0.9);
      color:white;
      border:none;
      width:24px;
      height:24px;
      border-radius:4px;
      cursor:pointer;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .image-preview-remove:hover{background:var(--danger)}
    
    .tag-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tag-item{
      background:var(--bg);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:6px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .tag-item button{
      padding:0;
      width:16px;
      height:16px;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:none;
      background:transparent;
      color:var(--danger);
    }
    
    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.8);
      z-index:1000;
      overflow-y:auto;
    }
    .modal-content{
      max-width:800px;
      margin:40px auto;
      background:var(--panel);
      border-radius:8px;
      padding:24px;
      position:relative;
    }
    .modal-close{
      position:absolute;
      top:16px;
      right:16px;
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:24px;
      cursor:pointer;
      padding:0;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modal-close:hover{color:var(--text)}
    
    .modal h2{color:var(--accent);font-size:20px;margin:0 0 16px}
    
    .saved-item{
      background:var(--bg);
      border:1px solid var(--border);
      padding:10px;
      border-radius:6px;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      transition:all 0.2s;
    }
    .saved-item:hover{border-color:var(--accent);background:rgba(125,211,252,0.05)}
    .saved-item-name{font-size:14px;font-weight:500}
    .saved-item-actions{display:flex;gap:8px}
    .saved-item-actions button{padding:4px 8px;font-size:12px}
    
    .template-editor{margin-top:12px}
    .template-editor textarea{width:100%;min-height:300px;font-family:monospace;font-size:13px}
    
    .template-manager{margin-bottom:16px}
    .template-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .template-item{
      background:var(--bg);
      border:1px solid var(--border);
      padding:12px;
      border-radius:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .template-item-name{font-size:14px;font-weight:500}
    
    .warning-box{
      background:rgba(239,68,68,0.1);
      border:1px solid var(--danger);
      border-radius:6px;
      padding:12px;
      margin-bottom:12px;
      font-size:13px;
      color:var(--danger);
    }
    
    @media(max-width:768px){
      .grid{grid-template-columns:1fr}
      .container{padding:16px;margin:10px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üá´üá∑ G√©n√©rateur de Publications</h1>
    
    <!-- Global Config -->
    <div class="section">
      <div class="section-title">‚öôÔ∏è Configuration globale</div>
      <div class="btn-row">
        <button id="openDiscordConfig" class="secondary">‚öôÔ∏è Configuration Discord</button>
        <button id="editTemplates" class="secondary">‚úèÔ∏è G√©rer les templates</button>
        <button id="manageTagsBtn" class="secondary">üè∑Ô∏è G√©rer les tags</button>
        <button id="exportTemplates" class="secondary">üì§ Exporter templates</button>
        <button id="importTemplates" class="secondary">üì• Importer templates</button>
        <button id="exportConfig">üì§ Exporter la configuration</button>
        <button id="importConfig" class="secondary">üì• Importer une configuration</button>
      </div>
    </div>
    
    <!-- Template Selection -->
    <div class="section">
      <div class="section-title">Type de publication</div>
      <div class="template-radio-group" id="templateRadioGroup">
        <!-- Les boutons radio seront g√©n√©r√©s dynamiquement ici -->
      </div>
    </div>
    
    
    <!-- Discord Post Content (always visible) -->
    <div class="section" id="postContentSection">
      <div class="section-title">üìù Contenu du post Discord</div>
      <div class="grid">
        <div class="field">
          <label>Titre du post (optionnel)</label>
          <input type="text" id="publisherTitle" placeholder="Par d√©faut: Nom du jeu">
        </div>
        <div class="field">
          <label>Tags Discord</label>
          <select id="publisherTagsSelect">
            <option value="">-- S√©lectionner un tag --</option>
          </select>
          <div class="tag-list" id="publisherTagsList"></div>
        </div>
      </div>
      <div class="field" style="margin-top:12px">
        <label>Images (cliquez sur une image pour la d√©finir comme principale)</label>
        <input type="file" id="publisherImage" accept="image/*" multiple>
        <div class="image-gallery" id="imageGallery"></div>
      </div>

      <div id="publisherStatus" style="margin-top:12px;font-size:14px"></div>
      <div style="margin-top:10px;color:var(--muted);font-size:13px;line-height:1.5">
        üí° Ces champs font partie du post envoy√© sur Discord. L'envoi restera impossible sans URL + cl√© API configur√©es.
      </div>
    </div>

    <!-- Variables Grid -->
    <div class="section">
      <div class="section-title">Donn√©es</div>
      <div class="grid" id="variablesGrid">
        <!-- Variables will be added here -->
      </div>
        <div class="btn-row">
        <button id="addVariable" class="secondary">‚ûï Ajouter une variable personnalis√©e</button>
        <button id="openPreviewModal">üëÅÔ∏è Aper√ßu</button>
        <button id="publishToDiscord">üöÄ Publier sur Discord</button>
        <button id="resetFields" class="danger">üóëÔ∏è R√©initialiser tous les champs</button>
      </div>

    <!-- Discord Publish -->
      </div>
  <!-- Modals -->
  
  <!-- Save Instructions Modal -->
  <div id="saveInstrModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeSaveInstr">‚úï</button>
      <h2>üíæ Sauvegarder les instructions</h2>
      <div class="field">
        <label>Nom du preset</label>
        <input type="text" id="instrName" placeholder="Ex: Installation standard">
      </div>
      <div class="btn-row">
        <button id="confirmSaveInstr">Sauvegarder</button>
        <button id="cancelSaveInstr" class="secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Load Instructions Modal -->
  <div id="loadInstrModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeLoadInstr">‚úï</button>
      <h2>üìÇ Charger des instructions</h2>
      <div id="savedInstrList"></div>
    </div>
  </div>

  <!-- Add Variable Modal -->
  <div id="addVarModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeAddVar">‚úï</button>
      <h2>‚ûï Ajouter une variable personnalis√©e</h2>
      <div class="field">
        <label>Nom de la variable (sans crochets)</label>
        <input type="text" id="varName" placeholder="Ex: developer">
      </div>
      <div class="field" style="margin-top:12px">
        <label>Label affich√©</label>
        <input type="text" id="varLabel" placeholder="Ex: D√©veloppeur">
      </div>
      <div class="field" style="margin-top:12px">
        <label>Type de champ</label>
        <select id="varType">
          <option value="text">Texte court</option>
          <option value="textarea">Texte long</option>
        </select>
      </div>
      <div class="btn-row">
        <button id="confirmAddVar">Ajouter</button>
        <button id="cancelAddVar" class="secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Edit Templates Modal -->
  <div id="editTemplatesModal" class="modal">
    <div class="modal-content" style="max-width:1000px">
      <button class="modal-close" id="closeEditTemplates">‚úï</button>
      <h2>‚úèÔ∏è G√©rer les templates</h2>
      
      <div style="background:rgba(125,211,252,0.1);border:1px solid var(--accent);border-radius:6px;padding:12px;margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;color:var(--accent)">üìù Variables disponibles :</div>
        <div id="availableVars" style="font-family:monospace;font-size:13px;line-height:1.8;color:var(--text)">
        </div>
        <div style="margin-top:8px;font-size:13px;color:var(--muted)">
          üí° Utilisez ces variables entre crochets pour qu'elles soient remplac√©es automatiquement
        </div>
      </div>
      
      <div class="template-manager">
        <div class="section-title">Templates existants</div>
        <div class="template-list" id="templateList"></div>
      </div>
      
      <div class="btn-row">
        <button id="addNewTemplate" class="secondary">‚ûï Nouveau template</button>
        <button id="saveAllTemplates">üíæ Sauvegarder tout</button>
        <button id="cancelEditTemplates" class="secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Template Editor Modal -->
  <div id="templateEditorModal" class="modal">
    <div class="modal-content" style="max-width:900px">
      <button class="modal-close" id="closeTemplateEditor">‚úï</button>
      <h2 id="templateEditorTitle">Nouveau template</h2>
      <div class="field">
        <label>Nom du template</label>
        <input type="text" id="templateEditorName" placeholder="Ex: Mon template custom">
      </div>
      <div class="field" style="margin-top:12px">
        <label>Cl√© du template (pour identification interne)</label>
        <input type="text" id="templateEditorKey" placeholder="Ex: mon_template" disabled>
      </div>
      <div class="field" style="margin-top:12px">
        <label>Type de publication Discord</label>
        <select id="templateEditorType">
          <option value="">Autres</option>
          <option value="my">Mes traductions</option>
          <option value="partner">Traductions partenaire</option>
        </select>
      </div>
      <div class="field" style="margin-top:12px">
        <label>Contenu du template</label>
        <textarea id="templateEditorContent" class="template-editor"></textarea>
      </div>
      <div class="btn-row">
        <button id="saveTemplateEditor">üíæ Sauvegarder</button>
        <button id="cancelTemplateEditor" class="secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Save Traductor Modal -->
  <div id="saveTraductorModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeSaveTraductor">‚úï</button>
      <h2>üíæ Sauvegarder le traducteur</h2>
      <div class="field">
        <label>Nom du traducteur</label>
        <input type="text" id="traductorName" placeholder="Ex: Rory Mercury 91">
      </div>
      <div class="btn-row">
        <button id="confirmSaveTraductor">Sauvegarder</button>
        <button id="cancelSaveTraductor" class="secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Import Templates Modal -->
  <div id="importTemplatesModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeImportTemplates">‚úï</button>
      <h2>üì• Importer des templates</h2>
      <div class="field">
        <label>Coller le JSON des templates</label>
        <textarea id="importTemplatesText" style="min-height:200px;font-family:monospace;font-size:12px"></textarea>
      </div>
      <div class="btn-row">
        <button id="confirmImportTemplates">Importer</button>
        <button id="cancelImportTemplates" class="secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Import Config Modal -->
  <div id="importConfigModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeImportConfig">‚úï</button>
      <h2>üì• Importer une configuration</h2>
      <div class="field">
        <label>Coller le JSON de configuration</label>
        <textarea id="importConfigText" style="min-height:200px;font-family:monospace;font-size:12px"></textarea>
      </div>
      <div class="btn-row">
        <button id="confirmImportConfig">Importer</button>
        <button id="cancelImportConfig" class="secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Manage Tags Modal -->
  <div id="manageTagsModal" class="modal">
    <div class="modal-content" style="max-width:900px">
      <button class="modal-close" id="closeManageTags">‚úï</button>
      <h2>üè∑Ô∏è G√©rer les tags sauvegard√©s</h2>

      <div class="grid">
        <div class="field">
          <label>Nom du tag</label>
          <input type="text" id="newTagName" placeholder="Ex: En cours üéÆ">
        </div>
        <div class="field">
          <label>ID Discord du tag</label>
          <input type="text" id="newTagId" placeholder="Ex: 123456789012345678">
        </div>
        <div class="field">
          <label>Template</label>
          <select id="newTagTemplate"></select>
        </div>
      </div>

      <div class="btn-row">
        <button id="addNewTag">‚ûï Ajouter</button>
      </div>

      <div style="margin-top:16px">
        <div class="section-title">Tags sauvegard√©s</div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 90px;gap:8px;margin-bottom:10px;color:var(--muted);font-size:12px">
          <div>Noms du tag</div>
          <div>ID Discord du tag</div>
          <div>Template</div>
          <div>Actions</div>
        </div>

        <div id="savedTagsList"></div>
      </div>
    </div>
  </div>
  </div>

  <!-- Discord Config Modal -->
  <div id="discordConfigModal" class="modal">
    <div class="modal-content" style="max-width:900px">
      <button class="modal-close" id="closeDiscordConfig">‚úï</button>
      <h2>‚öôÔ∏è Configuration Discord</h2>
      <div class="section" id="publishSection">
      <div class="section-title">Publication directe sur Discord (Forum)</div>
      <div id="publishDisabledWarning" class="warning-box" style="display:none">
        ‚ö†Ô∏è Publication d√©sactiv√©e : Le template actuel n'est pas compatible avec la publication Discord automatique. Seuls les templates "Mes traductions" (my) et "Traductions partenaire" (partner) sont support√©s.
      </div>
      <div id="publishContent">
        <div class="grid">
          <div class="field">
            <label>URL de l'API Publisher</label>
            <input type="text" id="publisherApiUrl" placeholder="https://votre-api-publisher.com/api/forum-post">
          </div>
          <div class="field">
            <label>Cl√© API (X-API-KEY)</label>
            <input type="password" id="publisherApiKey" placeholder="(stock√©e en local dans ton navigateur)">
          </div>
          <div class="field">
            <label>Template utilis√© pour la publication</label>
            <input type="text" id="publisherTemplateInfo" value="" disabled>
          </div>
        </div>
        <div class="btn-row">
          <button id="savePublisherSettings" class="secondary">üíæ Sauvegarder API/cl√©</button>
          <button id="clearPublisherKey" class="secondary">üßπ Effacer la cl√©</button>
        </div>
        <div style="margin-top:10px;color:var(--muted);font-size:13px;line-height:1.5">
          üí° Astuce : Votre URL d'API et votre cl√© sont stock√©es localement dans votre navigateur. Personne d'autre ne peut y acc√©der.
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal">
    <div class="modal-content" style="max-width:900px">
      <button class="modal-close" id="closePreviewModal">‚úï</button>
      <h2>üëÅÔ∏è Aper√ßu</h2>
      <div class="preview" id="preview">Remplissez les variables ci-dessus...</div>
      <div class="btn-row">
        <button id="copyPreview">üìã Copier la publication</button>
      </div>
    </div>
  </div>

  <script>
  const $ = id => document.getElementById(id);
    
    // Default variables configuration
    const defaultVarsConfig = [
      {name: 'Name_game', label: 'Nom du jeu', placeholder: 'Lost Solace', type: 'text', templates: ['mes', 'partenaire']},
      {name: 'Game_version', label: 'Version du jeu', placeholder: 'v0.1', type: 'text', templates: ['mes', 'partenaire', 'f95']},
      {name: 'Translate_version', label: 'Version de la traduction', placeholder: 'v0.1', type: 'text', templates: ['mes', 'partenaire', 'f95']},
      {name: 'Game_link', label: 'Lien du jeu', placeholder: 'https://...', type: 'text', templates: ['mes', 'partenaire', 'f95']},
      {name: 'Translate_link', label: 'Lien de la traduction', placeholder: 'https://...', type: 'text', templates: ['mes', 'partenaire', 'f95']},
      {name: 'traductor', label: 'Traducteur', placeholder: 'Rory Mercury 91', type: 'text', templates: ['partenaire', 'f95'], hasSaveLoad: true},
      {name: 'overview', label: 'Synopsis', placeholder: 'Synopsis du jeu...', type: 'textarea', templates: ['mes', 'partenaire']},
      {name: 'install_instructions', label: "Instructions d'installation", placeholder: "1. T√©l√©chargez le jeu...", type: 'textarea', templates: ['mes','partenaire','f95'], domId: 'instrText', fullWidth: true, showInAvailableVars: false, hasSaveLoad: true, saveLoad: 'instructions', hasIncludeToggle: true}
    ];
    
    // Load custom variables
    let customVars = [];
    try{
      const saved = localStorage.getItem('customVariables');
      if(saved) customVars = JSON.parse(saved);
    }catch(e){}
    
    const allVarsConfig = [...defaultVarsConfig, ...customVars];

    // Default templates
    const defaultTemplates = {
      mes: {
        name: 'Mes traductions',
        type: 'my',
        content: `## :flag_fr: [Name_game] est disponible en fran√ßais ! :tada:

Salut l'√©quipe ! Le patch est enfin pr√™t, vous pouvez l'installer d√®s maintenant pour profiter du titre dans notre langue. Bon jeu √† tous ! :point_down:

### :computer: Infos du Mod & Liens de T√©l√©chargement
* **Titre du jeu :** [Name_game]
* **Version du jeu :** [Game_version]
* **Version traduite :** [Translate_version]
* **Lien du jeu (VO) :** [Acc√®s au jeu original]([Game_link])
* **Lien de la Traduction :** [T√©l√©chargez la traduction FR ici !]([Translate_link])
> **Synopsis du jeu :**
> [overview]

### :sparkling_heart: Soutenez le Traducteur !

Pour m'encourager et soutenir mes efforts :
* **Soutien au Traducteur (Moi !) :** [Offrez-moi un caf√© pour le temps pass√© !](https://discord.com/channels/1417811606674477139/1433930090349330493)`
      },
      partenaire: {
        name: 'Traductions partenaire',
        type: 'partner',
        content: `## :flag_fr: [Name_game] est disponible en fran√ßais ! :tada:

Salut l'√©quipe ! Le patch est enfin pr√™t, vous pouvez l'installer d√®s maintenant pour profiter du titre dans notre langue. Bon jeu √† tous ! :point_down:

### :computer: Infos du Mod & Liens de T√©l√©chargement
* **Traducteur :** [traductor]
* **Titre du jeu :** [Name_game]
* **Version du jeu :** [Game_version]
* **Version traduite :** [Translate_version]
* **Lien du jeu (VO) :** [Acc√®s au jeu original]([Game_link])
* **Lien de la Traduction :** [T√©l√©chargez la traduction FR ici !]([Translate_link])
> **Synopsis du jeu :**
> [overview]`
      }
    };

    // Load templates
    let templates = {};
    try{
      const saved = localStorage.getItem('customTemplates');
      if(saved) {
        templates = JSON.parse(saved);
      } else {
        templates = {...defaultTemplates};
      }
    }catch(e){
      templates = {...defaultTemplates};
    }
    
    let currentTemplate = Object.keys(templates)[0] || 'mes';
    let currentEditingTemplateKey = null;
    let uploadedImages = [];
    let savedTraductors = [];
    let currentTags = [];
    let savedTags = [];
    
    // Load saved data
    try{
      const saved = localStorage.getItem('savedTraductors');
      if(saved) savedTraductors = JSON.parse(saved);
    }catch(e){}
    
    try{
      const saved = localStorage.getItem('savedTags');
      if(saved) savedTags = JSON.parse(saved);
    }catch(e){}

    // Migration: ancien format = tableau de strings
    if(Array.isArray(savedTags) && savedTags.length && typeof savedTags[0] === 'string'){
      savedTags = savedTags.map(name => ({ name, id: '', template: currentTemplate || '' }));
      localStorage.setItem('savedTags', JSON.stringify(savedTags));
    }
    if(!Array.isArray(savedTags)) savedTags = [];

    // Render template radio buttons
    function renderTemplateRadios(){
      const container = $('templateRadioGroup');
      container.innerHTML = '';
      
      Object.keys(templates).forEach(key => {
        const item = document.createElement('div');
        item.className = 'template-radio-item';
        
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'templateType';
        radio.value = key;
        radio.id = 'template_' + key;
        radio.checked = currentTemplate === key;
        
        const label = document.createElement('label');
        label.className = 'template-radio-label';
        label.htmlFor = 'template_' + key;
        label.textContent = templates[key].name || key;
        
        radio.addEventListener('change', ()=>{
          currentTemplate = key;
          renderVariablesGrid();
          updatePreview();
          updatePublisherTemplateInfo();
          checkPublishAvailability();
          updatePublisherTagSelect();
        });
        
        item.appendChild(radio);
        item.appendChild(label);
        container.appendChild(item);
      });
    }
    
    // Check if current template supports Discord publishing
    function checkPublishAvailability(){
      const template = templates[currentTemplate];
      const canPublish = template && (template.type === 'my' || template.type === 'partner');
      
      const section = $('publishSection');
      const warning = $('publishDisabledWarning');
      const content = $('publishContent');
      
            const publishBtn = $('publishToDiscord');
if(canPublish){
        warning.style.display = 'none';
        content.style.display = 'block';
        section.classList.remove('disabled');
        if(publishBtn) publishBtn.disabled = false;
      } else {
        warning.style.display = 'block';
        content.style.display = 'none';
        section.classList.add('disabled');
        if(publishBtn) publishBtn.disabled = true;
      }
    }
    
    // Render variables grid
    function renderVariablesGrid(){
      const grid = $('variablesGrid');
      grid.innerHTML = '';

      // ‚úÖ Objectif: afficher les champs sur TOUS les templates
      // - Si varConfig.templates est absent ‚Üí visible partout
      // - Si varConfig.templates est pr√©sent ‚Üí on essaie de matcher:
      //   1) la cl√© du template (currentTemplate)
      //   2) le type du template (templates[currentTemplate].type) si d√©fini
      // - Et si malgr√© √ßa rien ne matche, on bascule en "visible quand m√™me" (fallback)
      //   pour garantir "visible sur tout les template directement".
      const tpl = templates[currentTemplate] || {};
      const tplType = (tpl.type || '').trim();

      // Collecte des "cl√©s" possibles qui peuvent appara√Ætre dans varConfig.templates
      const keysToMatch = new Set([currentTemplate]);
      if(tplType) keysToMatch.add(tplType);

      const visibleVars = allVarsConfig.slice();


      visibleVars.forEach((varConfig) => {
        const isCustom = !defaultVarsConfig.includes(varConfig);
        const field = document.createElement('div');
        field.className = isCustom ? 'field custom' : 'field';
        if(varConfig.fullWidth) field.style.gridColumn = '1/-1';

        const labelContainer = document.createElement('div');
        labelContainer.style.display = 'flex';
        labelContainer.style.justifyContent = 'space-between';
        labelContainer.style.alignItems = 'center';

        const label = document.createElement('label');
        label.textContent = varConfig.label;
        labelContainer.appendChild(label);

        // Instructions include toggle + copy button (for the instructions field)
        if(varConfig.name === 'install_instructions'){
          const right = document.createElement('div');
          right.style.display = 'flex';
          right.style.alignItems = 'center';
          right.style.gap = '8px';
          right.style.flexWrap = 'wrap';

          const toggleWrap = document.createElement('div');
          toggleWrap.className = 'checkbox-group';
          toggleWrap.style.margin = '0';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.id = 'includeInstr';
          cb.checked = true;
          cb.addEventListener('change', updatePreview);

          const cbLabel = document.createElement('label');
          cbLabel.htmlFor = 'includeInstr';
          cbLabel.textContent = "Inclure dans la publication";

          toggleWrap.appendChild(cb);
          toggleWrap.appendChild(cbLabel);

          const copyBtn = document.createElement('button');
          copyBtn.id = 'copyInstr';
          copyBtn.textContent = 'üìã';
          copyBtn.style.padding = '2px 6px';
          copyBtn.style.fontSize = '12px';
          copyBtn.title = 'Copier les instructions';
          copyBtn.onclick = async (e) => {
            e.preventDefault();
            try{
              await navigator.clipboard.writeText($('instrText').value);
              copyBtn.textContent = '‚úÖ';
              copyBtn.classList.add('success');
              setTimeout(()=>{ copyBtn.textContent = 'üìã'; copyBtn.classList.remove('success'); }, 1200);
            }catch(err){ alert('Erreur copie'); }
          };

          right.appendChild(toggleWrap);
          right.appendChild(copyBtn);
          labelContainer.appendChild(right);
        }

        if(varConfig.hasSaveLoad){
          const btnGroup = document.createElement('div');
          btnGroup.style.display = 'flex';
          btnGroup.style.gap = '4px';

          const saveBtn = document.createElement('button');
          saveBtn.textContent = 'üíæ';
          saveBtn.style.padding = '2px 6px';
          saveBtn.style.fontSize = '12px';

          const loadBtn = document.createElement('button');
          loadBtn.textContent = 'üìÇ';
          loadBtn.style.padding = '2px 6px';
          loadBtn.style.fontSize = '12px';

          if(varConfig.saveLoad === 'instructions'){
            saveBtn.id = 'saveInstr';
            loadBtn.id = 'loadInstr';
            saveBtn.title = "Sauvegarder ces instructions";
            loadBtn.title = "Charger des instructions";
            saveBtn.onclick = (e)=>{ e.preventDefault(); $('instrName').value=''; $('saveInstrModal').style.display='block'; };
            loadBtn.onclick = (e)=>{ e.preventDefault(); openLoadInstrModal(); };
          } else {
            saveBtn.title = 'Sauvegarder ce traducteur';
            loadBtn.title = 'Charger un traducteur';
            saveBtn.onclick = (e) => { e.preventDefault(); openSaveTraductorModal(); };
            loadBtn.onclick = (e) => { e.preventDefault(); showTraductorDropdown(field); };
          }

          btnGroup.appendChild(saveBtn);
          btnGroup.appendChild(loadBtn);
          labelContainer.appendChild(btnGroup);
        }

        let input;

        if(varConfig.type === 'select'){
          input = document.createElement('select');
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = '-- S√©lectionner --';
          input.appendChild(emptyOption);
          (varConfig.options || []).forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            input.appendChild(option);
          });
        } else if(varConfig.type === 'textarea'){
          input = document.createElement('textarea');
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }

        input.id = (varConfig.domId || ('var_' + varConfig.name));
        if(varConfig.placeholder) input.placeholder = varConfig.placeholder;

        const existingInput = document.getElementById(varConfig.domId || ('var_' + varConfig.name));
        if(existingInput) {
          input.value = existingInput.value;
        }

        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);

        field.appendChild(labelContainer);
        field.appendChild(input);

        if(isCustom){
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-var';
          removeBtn.textContent = '‚úï';
          const customIndex = customVars.findIndex(v => v.name === varConfig.name);
          removeBtn.onclick = () => removeCustomVariable(customIndex);
          field.appendChild(removeBtn);
        }

        grid.appendChild(field);
      });

      updateAvailableVarsDisplay();
    }
    
    function showTraductorDropdown(parentField){
      if(savedTraductors.length === 0){
        alert('Aucun traducteur sauvegard√©');
        return;
      }
      
      const select = document.createElement('select');
      select.style.marginTop = '4px';
      
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '-- Choisir un traducteur --';
      select.appendChild(emptyOpt);
      
      savedTraductors.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      
      select.addEventListener('change', (e) => {
        const traductorInput = $('var_traductor');
        if(traductorInput && e.target.value){
          traductorInput.value = e.target.value;
          updatePreview();
        }
        select.remove();
      });
      
      parentField.appendChild(select);
      select.focus();
    }
    
    function openSaveTraductorModal(){
      const traductorInput = $('var_traductor');
      if(traductorInput){
        $('traductorName').value = traductorInput.value;
      }
      $('saveTraductorModal').style.display = 'block';
    }
    
    function updateAvailableVarsDisplay(){
      const display = $('availableVars');
      if(!display) return;
      
      display.innerHTML = allVarsConfig.filter(v => v.showInAvailableVars !== false).map(v => 
        `<code>[${v.name}]</code> ‚Üí ${v.label}`
      ).join('<br>');
    }
    
    function removeCustomVariable(index){
      if(!confirm('Supprimer cette variable personnalis√©e ?')) return;
      const varToRemove = customVars[index];
      customVars.splice(index, 1);
      localStorage.setItem('customVariables', JSON.stringify(customVars));
      
      const allIndex = allVarsConfig.findIndex(v => v.name === varToRemove.name);
      if(allIndex !== -1) {
        allVarsConfig.splice(allIndex, 1);
      }
      
      renderVariablesGrid();
      updatePreview();
    }
    
    function updatePreview(){
      const template = templates[currentTemplate];
      if(!template) return;

      const format = template.format || 'markdown'; // d√©faut: markdown

      let content = template.content;

      // 1) Remplacement variables (fixes + custom)
      allVarsConfig.forEach(varConfig => {
        const input = $(varConfig.domId || ('var_' + varConfig.name));
        if(!input) return;

        let val = input.value.trim();

        // ‚ö†Ô∏è Seulement pour Markdown natif (Discord)
        if(format === 'markdown' && varConfig.name === 'overview' && val){
          const lines = val.split('\n').map(l=>l.trim()).filter(Boolean);
          val = lines.join('\n> ');
        }

        content = content.split(`[${varConfig.name}]`).join(val || `[${varConfig.name}]`);
      });

      // 2) Instructions (si coch√©es)
      if($('includeInstr')?.checked){
        const instr = $('instrText').value.trim();
        if(instr){
          const lines = instr.split('\n').map(l=>l.trim()).filter(Boolean);

          if(format === 'markdown'){
            content += '\n\n**Instructions d\'installation :**\n' + lines.map(l=>'* '+l).join('\n');
          } else {
            // BBCode pour F95
            content += `\n\n[SPOILER="INSTALLATION"]\n[LIST=1]\n` +
              lines.map(l=>`[*]${l}`).join('\n') +
              `\n[/LIST]\n[/SPOILER]`;
          }
        }
      }

      $('preview').textContent = content;
    }
    
    function updatePublisherTemplateInfo(){
      const template = templates[currentTemplate];
      if(!template) return;
      
      const type = template.type;
      let displayValue = '';
      
      if(type === 'my' || type === 'partner'){
        displayValue = `${template.name} (${type})`;
      } else {
        displayValue = 'Non publiable automatiquement';
      }
      
      $('publisherTemplateInfo').value = displayValue;
    }

    // Image handling
    function handleImageUpload(files){
      Array.from(files).forEach(file => {
        if(!file.type.startsWith('image/')) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImages.push({
            file: file,
            dataUrl: e.target.result,
            isMain: uploadedImages.length === 0
          });
          renderImageGallery();
        };
        reader.readAsDataURL(file);
      });
    }
    
    function renderImageGallery(){
      const gallery = $('imageGallery');
      gallery.innerHTML = '';
      
      uploadedImages.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'image-preview-item' + (img.isMain ? ' main' : '');
        
        const imgEl = document.createElement('img');
        imgEl.src = img.dataUrl;
        
        if(img.isMain){
          const badge = document.createElement('div');
          badge.className = 'image-preview-badge';
          badge.textContent = 'PRINCIPALE';
          item.appendChild(badge);
        }
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'image-preview-remove';
        removeBtn.textContent = '‚úï';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          uploadedImages.splice(index, 1);
          if(uploadedImages.length > 0 && img.isMain){
            uploadedImages[0].isMain = true;
          }
          renderImageGallery();
        };
        
        item.onclick = () => {
          uploadedImages.forEach(i => i.isMain = false);
          img.isMain = true;
          renderImageGallery();
        };
        
        item.appendChild(imgEl);
        item.appendChild(removeBtn);
        gallery.appendChild(item);
      });
    }
    
    // Tags management
    function getTemplateOptions(){
      return Object.keys(templates).map(key => ({
        key,
        name: (templates[key] && templates[key].name) ? templates[key].name : key
      }));
    }

    function renderNewTagTemplateSelect(){
      const sel = $('newTagTemplate');
      if(!sel) return;
      sel.innerHTML = '';
      const opts = getTemplateOptions();
      opts.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.key;
        opt.textContent = `${o.name} (${o.key})`;
        sel.appendChild(opt);
      });
      if(opts.length) sel.value = currentTemplate || opts[0].key;
    }

    function updatePublisherTagSelect(){
      const sel = $('publisherTagsSelect');
      if(!sel) return;

      sel.innerHTML = '';
      const empty = document.createElement('option');
      empty.value = '';
      empty.textContent = '-- S√©lectionner un tag --';
      sel.appendChild(empty);

      // Tags actifs = tags dont template === currentTemplate
      const active = savedTags.filter(t => t && t.template === currentTemplate);

      active.forEach(t => {
        const opt = document.createElement('option');
        opt.value = (t.id || '').trim();
        opt.textContent = t.id ? `${t.name} ‚Äî ${t.id}` : t.name;
        opt.dataset.name = t.name;
        sel.appendChild(opt);
      });
    }

    function renderTagsList(){
      const list = $('publisherTagsList');
      list.innerHTML = '';

      currentTags.forEach((tagObj, index) => {
        const item = document.createElement('div');
        item.className = 'tag-item';

        const name = document.createElement('span');
        name.textContent = tagObj && tagObj.name ? tagObj.name : (tagObj.id || '');

        const removeBtn = document.createElement('button');
        removeBtn.textContent = '‚úï';
        removeBtn.onclick = () => {
          currentTags.splice(index, 1);
          renderTagsList();
        };

        item.appendChild(name);
        item.appendChild(removeBtn);
        list.appendChild(item);
      });
    }

    function persistSavedTags(){
      localStorage.setItem('savedTags', JSON.stringify(savedTags));
      updatePublisherTagSelect();
    }

    function renderSavedTagsList(){
      const list = $('savedTagsList');
      list.innerHTML = '';

      if(savedTags.length === 0){
        list.innerHTML = '<p style="color:var(--muted)">Aucun tag sauvegard√©</p>';
        return;
      }

      savedTags.forEach((tag, index) => {
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 1fr 1fr 90px';
        row.style.gap = '8px';
        row.style.marginBottom = '8px';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = tag.name || '';
        nameInput.placeholder = 'Nom du tag';

        const idInput = document.createElement('input');
        idInput.type = 'text';
        idInput.value = tag.id || '';
        idInput.placeholder = 'ID Discord';

        const tplSelect = document.createElement('select');
        getTemplateOptions().forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.key;
          opt.textContent = `${o.name} (${o.key})`;
          tplSelect.appendChild(opt);
        });
        tplSelect.value = tag.template || currentTemplate;

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '8px';
        actions.style.alignItems = 'center';

        const useBtn = document.createElement('button');
        useBtn.textContent = 'Utiliser';
        useBtn.onclick = () => addTagFromSavedIndex(index);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Supprimer';
        delBtn.className = 'danger';
        delBtn.onclick = () => deleteTag(index);

        actions.appendChild(useBtn);
        actions.appendChild(delBtn);

        const sync = () => {
          savedTags[index] = {
            name: nameInput.value.trim(),
            id: idInput.value.trim(),
            template: tplSelect.value
          };
          persistSavedTags();
        };

        nameInput.addEventListener('change', sync);
        idInput.addEventListener('change', sync);
        tplSelect.addEventListener('change', sync);

        row.appendChild(nameInput);
        row.appendChild(idInput);
        row.appendChild(tplSelect);
        row.appendChild(actions);

        list.appendChild(row);
      });
    }

    function addTagFromSavedIndex(index){
      const t = savedTags[index];
      if(!t) return;

      // Emp√™che les doublons par ID si dispo, sinon par nom
      const key = (t.id || t.name || '').trim();
      if(!key) return;

      const exists = currentTags.some(x => ((x.id || x.name || '').trim() === key));
      if(!exists){
        currentTags.push({ name: t.name || t.id, id: t.id || t.name });
        renderTagsList();
      }

      // reset select UI si pr√©sent
      const sel = $('publisherTagsSelect');
      if(sel) sel.value = '';
    }

    window.deleteTag = function(index){
      if(!confirm('Supprimer ce tag ?')) return;
      savedTags.splice(index, 1);
      persistSavedTags();
      renderSavedTagsList();
    };

    // Template management

    function renderTemplateList(){
      const list = $('templateList');
      list.innerHTML = '';
      
      Object.keys(templates).forEach(key => {
        const item = document.createElement('div');
        item.className = 'template-item';
        
        const nameEl = document.createElement('div');
        nameEl.className = 'template-item-name';
        nameEl.textContent = templates[key].name || key;
        
        const typeInfo = document.createElement('div');
        typeInfo.style.fontSize = '12px';
        typeInfo.style.color = 'var(--muted)';
        if(templates[key].type === 'my') typeInfo.textContent = '(Mes traductions)';
        else if(templates[key].type === 'partner') typeInfo.textContent = '(Partenaire)';
        else typeInfo.textContent = '(Manuel uniquement)';
        
        const nameContainer = document.createElement('div');
        nameContainer.appendChild(nameEl);
        nameContainer.appendChild(typeInfo);
        
        const actions = document.createElement('div');
        actions.className = 'saved-item-actions';
        
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Modifier';
        editBtn.onclick = () => openTemplateEditor(key);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Supprimer';
        deleteBtn.className = 'danger';
        deleteBtn.onclick = () => deleteTemplate(key);
        
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        
        item.appendChild(nameContainer);
        item.appendChild(actions);
        list.appendChild(item);
      });
    }
    
    function openTemplateEditor(key = null){
      currentEditingTemplateKey = key;
      
      if(key){
        $('templateEditorTitle').textContent = 'Modifier le template';
        $('templateEditorName').value = templates[key].name || key;
        $('templateEditorKey').value = key;
        $('templateEditorType').value = templates[key].type || '';
        $('templateEditorContent').value = templates[key].content || '';
      } else {
        $('templateEditorTitle').textContent = 'Nouveau template';
        $('templateEditorName').value = '';
        $('templateEditorKey').value = '';
        $('templateEditorType').value = '';
        $('templateEditorContent').value = '';
      }
      
      $('editTemplatesModal').style.display = 'none';
      $('templateEditorModal').style.display = 'block';
    }
    
    function deleteTemplate(key){
      if(!confirm(`Supprimer le template "${templates[key].name || key}" ?`)) return;
      
      delete templates[key];
      localStorage.setItem('customTemplates', JSON.stringify(templates));
      
      if(currentTemplate === key){
        currentTemplate = Object.keys(templates)[0] || 'mes';
      }
      
      renderTemplateList();
      renderTemplateRadios();
      updatePreview();
      updatePublisherTemplateInfo();
      checkPublishAvailability();
    }
    
    // Global config export/import
    function exportGlobalConfig(){
      const config = {
        templates: templates,
        customVariables: customVars,
        savedInstructions: JSON.parse(localStorage.getItem('savedInstructions') || '{}'),
        savedTraductors: savedTraductors,
        savedTags: savedTags,
        publisherApiUrl: localStorage.getItem('publisherApiUrl') || '',
        version: '2.0'
      };
      
      const json = JSON.stringify(config, null, 2);
      navigator.clipboard.writeText(json).then(()=>{
        alert('‚úÖ Configuration export√©e dans le presse-papier !');
      }).catch(()=>{
        const blob = new Blob([json], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'config_publication_generator.json';
        a.click();
        alert('‚úÖ Configuration t√©l√©charg√©e !');
      });
    }
    
    function importGlobalConfig(configJson){
      try{
        const config = JSON.parse(configJson);
        
        if(config.templates) {
          templates = config.templates;
          localStorage.setItem('customTemplates', JSON.stringify(templates));
        }
        
        if(config.customVariables) {
          customVars = config.customVariables;
          localStorage.setItem('customVariables', JSON.stringify(customVars));
        }
        
        if(config.savedInstructions) {
          localStorage.setItem('savedInstructions', JSON.stringify(config.savedInstructions));
        }
        
        if(config.savedTraductors) {
          savedTraductors = config.savedTraductors;
          localStorage.setItem('savedTraductors', JSON.stringify(savedTraductors));
        }
        
        if(config.savedTags) {
          savedTags = config.savedTags;
          localStorage.setItem('savedTags', JSON.stringify(savedTags));
        }
        
        if(config.publisherApiUrl) {
          localStorage.setItem('publisherApiUrl', config.publisherApiUrl);
        }
        
        location.reload();
      }catch(e){
        alert('‚ùå Erreur : Configuration invalide');
      }
    }

    // Reset all fields (silent)
    function resetAllFields(){

      // Reset all variable inputs
      allVarsConfig.forEach(varConfig => {
        const input = $('var_' + varConfig.name);
        if(input) input.value = '';
      });

      // Reset instructions to default
      $('instrText').value = ``;

      // Reset include instructions checkbox
      $('includeInstr').checked = true;

      // Reset publisher fields
      $('publisherTitle').value = '';

      // Reset tags
      currentTags = [];
      renderTagsList();

      // Reset images
      uploadedImages = [];
      renderImageGallery();
      $('publisherImage').value = '';

      // Refresh preview
      updatePreview();
    }

    // Event listeners
    if($('includeInstr')) $('includeInstr').addEventListener('change', updatePreview);
    if($('instrText')) $('instrText').addEventListener('input', updatePreview);
    
    $('publisherImage').addEventListener('change', (e) => {
      handleImageUpload(e.target.files);
    });
    
    $('publisherTagsSelect').addEventListener('change', (e) => {
      const id = (e.target.value || '').trim();
      if(!id) return;

      const opt = e.target.options[e.target.selectedIndex];
      const name = opt && opt.dataset && opt.dataset.name ? opt.dataset.name : id;

      const exists = currentTags.some(t => (t.id || '').trim() === id);
      if(!exists){
        currentTags.push({ name, id });
        renderTagsList();
      }
      e.target.value = '';
    });
    
    // Reset fields button
    $('resetFields').addEventListener('click', resetAllFields);



    // Discord config modal
    if($('openDiscordConfig')) $('openDiscordConfig').addEventListener('click', ()=>{
      $('discordConfigModal').style.display = 'block';
    });

    if($('closeDiscordConfig')) $('closeDiscordConfig').addEventListener('click', ()=>{
      $('discordConfigModal').style.display = 'none';
    });

    if($('discordConfigModal')) $('discordConfigModal').addEventListener('click', (e)=>{
      if(e.target === $('discordConfigModal')) $('discordConfigModal').style.display = 'none';
    });

    // Preview modal
    $('openPreviewModal').addEventListener('click', ()=>{
      updatePreview();
      $('previewModal').style.display = 'block';
    });

    $('closePreviewModal').addEventListener('click', ()=>{
      $('previewModal').style.display = 'none';
    });

    // Close preview modal when clicking outside content
    $('previewModal').addEventListener('click', (e)=>{
      if(e.target === $('previewModal')) $('previewModal').style.display = 'none';
    });



    // Copy buttons
    if($('copyInstr')) $('copyInstr').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText($('instrText').value);
        $('copyInstr').textContent = '‚úÖ Copi√© !';
        $('copyInstr').classList.add('success');
        setTimeout(()=>{
          $('copyInstr').textContent = 'üìã Copier instructions';
          $('copyInstr').classList.remove('success');
        },1500);
      }catch(e){alert('Erreur copie')}
    });
    
    $('copyPreview').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText($('preview').textContent);
        $('copyPreview').textContent = '‚úÖ Copi√© !';
        $('copyPreview').classList.add('success');
        setTimeout(()=>{
          $('copyPreview').textContent = 'üìã Copier la publication';
          $('copyPreview').classList.remove('success');
        },1500);
      }catch(e){alert('Erreur copie')}
    });
    
    
    function openLoadInstrModal(){
      let saved = {};
      try{
        const data = localStorage.getItem('savedInstructions');
        if(data) saved = JSON.parse(data);
      }catch(e){}

      const list = $('savedInstrList');
      list.innerHTML = '';

      if(Object.keys(saved).length === 0){
        list.innerHTML = '<p style="color:var(--muted)">Aucune instruction sauvegard√©e</p>';
      } else {
        Object.keys(saved).forEach(name => {
          const item = document.createElement('div');
          item.className = 'saved-item';
          item.innerHTML = `
            <div class="saved-item-name">${name}</div>
            <div class="saved-item-actions">
              <button onclick="loadInstruction('${name.replace(/'/g, "\\'")}')">Charger</button>
              <button class="danger" onclick="deleteInstruction('${name.replace(/'/g, "\\'")}')">Supprimer</button>
            </div>
          `;
          list.appendChild(item);
        });
      }

      $('loadInstrModal').style.display = 'block';
    }

// Save/Load Instructions
    if($('saveInstr')) $('saveInstr').addEventListener('click', ()=>{
      $('instrName').value = '';
      $('saveInstrModal').style.display = 'block';
    });
    
    $('closeSaveInstr').addEventListener('click', ()=>{
      $('saveInstrModal').style.display = 'none';
    });
    
    $('cancelSaveInstr').addEventListener('click', ()=>{
      $('saveInstrModal').style.display = 'none';
    });
    
    $('confirmSaveInstr').addEventListener('click', ()=>{
      const name = $('instrName').value.trim();
      if(!name){
        alert('Veuillez entrer un nom');
        return;
      }
      
      const instr = $('instrText').value;
      let saved = {};
      try{
        const data = localStorage.getItem('savedInstructions');
        if(data) saved = JSON.parse(data);
      }catch(e){}
      
      saved[name] = instr;
      localStorage.setItem('savedInstructions', JSON.stringify(saved));
      
      $('saveInstrModal').style.display = 'none';
      alert('Instructions sauvegard√©es !');
    });
    
    if($('loadInstr')) $('loadInstr').addEventListener('click', ()=>{ openLoadInstrModal(); });
$('closeLoadInstr').addEventListener('click', ()=>{
      $('loadInstrModal').style.display = 'none';
    });
    
    window.loadInstruction = function(name){
      try{
        const data = localStorage.getItem('savedInstructions');
        const saved = JSON.parse(data);
        $('instrText').value = saved[name] || '';
        $('loadInstrModal').style.display = 'none';
        updatePreview();
      }catch(e){alert('Erreur de chargement')}
    };
    
    window.deleteInstruction = function(name){
      if(!confirm(`Supprimer "${name}" ?`)) return;
      try{
        const data = localStorage.getItem('savedInstructions');
        const saved = JSON.parse(data);
        delete saved[name];
        localStorage.setItem('savedInstructions', JSON.stringify(saved));
        $('loadInstr').click();
      }catch(e){alert('Erreur de suppression')}
    };
    
    // Save Traductor
    $('closeSaveTraductor').addEventListener('click', ()=>{
      $('saveTraductorModal').style.display = 'none';
    });
    
    $('cancelSaveTraductor').addEventListener('click', ()=>{
      $('saveTraductorModal').style.display = 'none';
    });
    
    $('confirmSaveTraductor').addEventListener('click', ()=>{
      const name = $('traductorName').value.trim();
      if(!name){
        alert('Veuillez entrer un nom');
        return;
      }
      
      if(!savedTraductors.includes(name)){
        savedTraductors.push(name);
        localStorage.setItem('savedTraductors', JSON.stringify(savedTraductors));
      }
      
      const traductorInput = $('var_traductor');
      if(traductorInput){
        traductorInput.value = name;
        updatePreview();
      }
      
      $('saveTraductorModal').style.display = 'none';
      alert('Traducteur sauvegard√© !');
    });
    
    // Add Variable
    $('addVariable').addEventListener('click', ()=>{
      $('varName').value = '';
      $('varLabel').value = '';
      $('varType').value = 'text';
      $('addVarModal').style.display = 'block';
    });
    
    $('closeAddVar').addEventListener('click', ()=>{
      $('addVarModal').style.display = 'none';
    });
    
    $('cancelAddVar').addEventListener('click', ()=>{
      $('addVarModal').style.display = 'none';
    });
    
    $('confirmAddVar').addEventListener('click', ()=>{
      const name = $('varName').value.trim();
      const label = $('varLabel').value.trim();
      const type = $('varType').value;
      
      if(!name || !label){
        alert('Veuillez remplir tous les champs');
        return;
      }
      
      if(allVarsConfig.some(v => v.name === name)){
        alert('Cette variable existe d√©j√†');
        return;
      }
      
      const newVar = {
        name: name,
        label: label,
        placeholder: '',
        type: type
      };
      
      customVars.push(newVar);
      allVarsConfig.push(newVar);
      localStorage.setItem('customVariables', JSON.stringify(customVars));
      
      $('addVarModal').style.display = 'none';
      renderVariablesGrid();
      updatePreview();
    });

    // Edit Templates
    $('editTemplates').addEventListener('click', ()=>{
      updateAvailableVarsDisplay();
      renderTemplateList();
      $('editTemplatesModal').style.display = 'block';
    });
    
    $('closeEditTemplates').addEventListener('click', ()=>{
      $('editTemplatesModal').style.display = 'none';
    });
    
    $('cancelEditTemplates').addEventListener('click', ()=>{
      $('editTemplatesModal').style.display = 'none';
    });
    
    $('addNewTemplate').addEventListener('click', ()=>{
      openTemplateEditor(null);
    });
    
    $('saveAllTemplates').addEventListener('click', ()=>{
      localStorage.setItem('customTemplates', JSON.stringify(templates));
      $('editTemplatesModal').style.display = 'none';
      alert('Templates sauvegard√©s !');
    });
    
    // Template Editor
    $('closeTemplateEditor').addEventListener('click', ()=>{
      $('templateEditorModal').style.display = 'none';
      $('editTemplatesModal').style.display = 'block';
    });
    
    $('cancelTemplateEditor').addEventListener('click', ()=>{
      $('templateEditorModal').style.display = 'none';
      $('editTemplatesModal').style.display = 'block';
    });
    
    $('templateEditorName').addEventListener('input', (e) => {
      if(!currentEditingTemplateKey){
        const key = e.target.value.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        $('templateEditorKey').value = key;
      }
    });
    
    $('saveTemplateEditor').addEventListener('click', ()=>{
      const name = $('templateEditorName').value.trim();
      const content = $('templateEditorContent').value;
      const type = $('templateEditorType').value;
      
      if(!name){
        alert('Veuillez entrer un nom pour le template');
        return;
      }
      
      let key = currentEditingTemplateKey;
      
      if(!key){
        key = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        let counter = 1;
        while(templates[key]){
          key = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') + '_' + counter;
          counter++;
        }
      }
      
      templates[key] = {
        name: name,
        type: type || null,
        content: content
      };
      
      localStorage.setItem('customTemplates', JSON.stringify(templates));
      
      $('templateEditorModal').style.display = 'none';
      $('editTemplatesModal').style.display = 'block';
      
      renderTemplateList();
      renderTemplateRadios();
      updatePreview();
      updatePublisherTemplateInfo();
      checkPublishAvailability();
    });
    
    // Export/Import Templates
    $('exportTemplates').addEventListener('click', ()=>{
      const json = JSON.stringify(templates, null, 2);
      navigator.clipboard.writeText(json).then(()=>{
        alert('Templates export√©s dans le presse-papier !');
      }).catch(()=>{
        const blob = new Blob([json], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'templates.json';
        a.click();
      });
    });
    
    $('importTemplates').addEventListener('click', ()=>{
      $('importTemplatesText').value = '';
      $('importTemplatesModal').style.display = 'block';
    });
    
    $('closeImportTemplates').addEventListener('click', ()=>{
      $('importTemplatesModal').style.display = 'none';
    });
    
    $('cancelImportTemplates').addEventListener('click', ()=>{
      $('importTemplatesModal').style.display = 'none';
    });
    
    $('confirmImportTemplates').addEventListener('click', ()=>{
      const json = $('importTemplatesText').value.trim();
      if(!json){
        alert('Veuillez coller le JSON des templates');
        return;
      }
      
      try{
        const imported = JSON.parse(json);
        
        if(confirm('Voulez-vous fusionner avec les templates existants ?\n(Annuler = remplacer tous les templates)')){
          Object.assign(templates, imported);
        } else {
          templates = imported;
        }
        
        localStorage.setItem('customTemplates', JSON.stringify(templates));
        
        $('importTemplatesModal').style.display = 'none';
        renderTemplateRadios();
        updatePreview();
        updatePublisherTemplateInfo();
        checkPublishAvailability();
        alert('Templates import√©s !');
      }catch(e){
        alert('Erreur : JSON invalide');
      }
    });
    
    // Global Config
    $('exportConfig').addEventListener('click', exportGlobalConfig);
    
    $('importConfig').addEventListener('click', ()=>{
      $('importConfigText').value = '';
      $('importConfigModal').style.display = 'block';
    });
    
    $('closeImportConfig').addEventListener('click', ()=>{
      $('importConfigModal').style.display = 'none';
    });
    
    $('cancelImportConfig').addEventListener('click', ()=>{
      $('importConfigModal').style.display = 'none';
    });
    
    $('confirmImportConfig').addEventListener('click', ()=>{
      const json = $('importConfigText').value.trim();
      if(!json){
        alert('Veuillez coller le JSON de configuration');
        return;
      }
      
      if(confirm('‚ö†Ô∏è Cela va remplacer TOUTE votre configuration actuelle. Continuer ?')){
        importGlobalConfig(json);
      }
    });
    
    // Manage Tags
    $('manageTagsBtn').addEventListener('click', ()=>{
      renderNewTagTemplateSelect();
      renderSavedTagsList();
      $('manageTagsModal').style.display = 'block';
    });
    
    $('closeManageTags').addEventListener('click', ()=>{
      $('manageTagsModal').style.display = 'none';
    });
    
    $('addNewTag').addEventListener('click', ()=>{
      const name = $('newTagName').value.trim();
      const id = $('newTagId').value.trim();
      const templateKey = $('newTagTemplate').value;

      if(!name){
        alert('Veuillez entrer un nom de tag');
        return;
      }
      if(!id){
        alert('Veuillez entrer l‚ÄôID Discord du tag');
        return;
      }
      if(!templateKey){
        alert('Veuillez s√©lectionner un template');
        return;
      }

      const exists = savedTags.some(t => (t.id || '').trim() === id || (t.name || '').trim().toLowerCase() === name.toLowerCase());
      if(exists){
        alert('Ce tag existe d√©j√† (m√™me nom ou m√™me ID)');
        return;
      }

      savedTags.push({ name, id, template: templateKey });
      persistSavedTags();
      renderSavedTagsList();

      $('newTagName').value = '';
      $('newTagId').value = '';
      if($('newTagTemplate')) $('newTagTemplate').value = currentTemplate || templateKey;
    });

    // Publisher functions
    function loadPublisherSettings(){
      try{
        const savedUrl = localStorage.getItem('publisherApiUrl');
        const savedKey = localStorage.getItem('publisherApiKey');
        if(savedUrl && savedUrl.trim()) $('publisherApiUrl').value = savedUrl.trim();
        if(savedKey && savedKey.trim()) $('publisherApiKey').value = savedKey;
      }catch(e){}
    }

    function savePublisherSettings(){
      try{
        localStorage.setItem('publisherApiUrl', $('publisherApiUrl').value.trim());
        localStorage.setItem('publisherApiKey', $('publisherApiKey').value);
      }catch(e){}
    }

    function clearPublisherKey(){
      if(!confirm('Effacer la cl√© API enregistr√©e ?')) return;
      try{
        localStorage.removeItem('publisherApiKey');
        $('publisherApiKey').value = '';
      }catch(e){}
    }

    function mapTemplateForPublisher(){
      const template = templates[currentTemplate];
      return template ? template.type : null;
    }

    function guessDefaultTitle(){
      const override = $('publisherTitle').value.trim();
      if(override) return override;
      const nameGame = $('var_Name_game') ? $('var_Name_game').value.trim() : '';
      const nameGame2 = $('var_NAME_GAME') ? $('var_NAME_GAME').value.trim() : '';
      return nameGame || nameGame2 || 'Nouvelle publication';
    }

    async function publishCurrentToDiscord(){
      const statusEl = $('publisherStatus');
      statusEl.textContent = '';

      const apiUrl = $('publisherApiUrl').value.trim();
      const apiKey = $('publisherApiKey').value;
      const template = mapTemplateForPublisher();

      if(!apiUrl){
        statusEl.textContent = "‚ùå Renseigne l'URL de l'API Publisher.";
        return;
      }
      if(!apiKey || !apiKey.trim()){
        statusEl.textContent = "‚ùå Renseigne la cl√© API (X-API-KEY).";
        return;
      }
      if(!template){
        statusEl.textContent = "‚ùå Le template actuel n'est pas publiable automatiquement.";
        return;
      }

      const title = guessDefaultTitle();
      const content = $('preview').textContent;
      const tags = currentTags.map(t => (t && t.id ? t.id : '')).filter(Boolean).join(', ');
      
      const mainImage = uploadedImages.find(img => img.isMain);
      
      const fd = new FormData();
      fd.append('title', title);
      fd.append('content', content);
      fd.append('tags', tags);
      fd.append('template', template);
      if(mainImage) fd.append('image', mainImage.file);

      const btn = $('publishToDiscord');
      const oldText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚è≥ Publication...';

      try{
        const headers = {'X-API-KEY': apiKey};

        const res = await fetch(apiUrl, {method:'POST', headers, body: fd});
        const data = await res.json().catch(()=>null);

        if(!res.ok || !data || !data.ok){
          const details = data && (data.error || (data.details && JSON.stringify(data.details))) ? (data.error || JSON.stringify(data.details)) : 'Erreur inconnue';
          statusEl.textContent = '‚ùå √âchec : ' + details;
          return;
        }

        const url = data.thread_url || '';
        statusEl.innerHTML = url 
          ? `‚úÖ Post cr√©√© : <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`
          : '‚úÖ Post cr√©√©.';

      }catch(e){
        statusEl.textContent = '‚ùå Erreur r√©seau : ' + (e && e.message ? e.message : e);
      }finally{
        btn.disabled = false;
        btn.textContent = oldText;
      }
    }

    $('savePublisherSettings').addEventListener('click', ()=>{
      savePublisherSettings();
      $('savePublisherSettings').textContent = '‚úÖ Sauvegard√© !';
      $('savePublisherSettings').classList.add('success');
      setTimeout(()=>{
        $('savePublisherSettings').textContent = 'üíæ Sauvegarder API/cl√©';
        $('savePublisherSettings').classList.remove('success');
      },1500);
    });

    $('clearPublisherKey').addEventListener('click', clearPublisherKey);
    $('publishToDiscord').addEventListener('click', ()=>{
      savePublisherSettings();
      publishCurrentToDiscord();
    });
    
    // Initialize
    renderTemplateRadios();
    renderVariablesGrid();
    updatePreview();
    updatePublisherTemplateInfo();
    checkPublishAvailability();
    loadPublisherSettings();
    updatePublisherTagSelect();
  </script>
</body>
</html>