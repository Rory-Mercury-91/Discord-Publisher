<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>G√©n√©rateur de publications - Master</title>
  <style>
    :root{
      --bg:#0b0f12;
      --panel:#0f1720;
      --border:rgba(255,255,255,0.06);
      --muted:#9aa5b1;
      --accent:#7dd3fc;
      --accent-2:#f472b6;
      --text:#e6eef6;
      --success:#4ade80;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1050px;margin:20px auto;padding:24px}
    h1{margin:0 0 20px;font-size:22px;font-weight:600}
    .section{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px}
    .section.disabled{opacity:0.45;pointer-events:none;filter:grayscale(0.85)}
    .section.hidden{display:none}
    .section-title{font-size:14px;font-weight:650;margin-bottom:12px;color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px;position:relative}
    .field label{font-size:13px;color:var(--muted);font-weight:550}
    .field input,.field textarea,.field select{
      background:var(--bg);border:1px solid var(--border);padding:9px 10px;border-radius:8px;color:var(--text);font-size:14px;
    }
    .field textarea{min-height:90px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    button{
      background:var(--panel);border:1px solid var(--border);padding:8px 14px;border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600
    }
    button:hover{border-color:rgba(125,211,252,0.5);background:rgba(125,211,252,0.06)}
    button.success{color:var(--success)}
    button.danger{color:var(--danger)}
    button.secondary{color:var(--accent-2)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{height:8px}

    /* Template Radios */
    .template-radio-group{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .template-radio-item{position:relative}
    .template-radio-item input{position:absolute;opacity:0;width:0;height:0}
    .template-radio-label{
      display:inline-block;background:var(--bg);border:2px solid var(--border);
      padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px;transition:0.2s;
      user-select:none
    }
    .template-radio-item input:checked + .template-radio-label{
      border-color:var(--accent);color:var(--accent);background:rgba(125,211,252,0.10);
    }

    /* Preview */
    .preview{
      background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      white-space:pre-wrap;max-height:420px;overflow-y:auto;font-size:13px;line-height:1.6
    }

    /* Tags chips */
    .tag-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .tag-chip{
      background:var(--bg);border:1px solid var(--border);padding:5px 10px;border-radius:999px;
      font-size:12px;cursor:pointer;transition:0.2s;user-select:none
    }
    .tag-chip:hover{border-color:rgba(125,211,252,0.55)}
    .tag-chip.active{background:var(--accent);color:#000;border-color:var(--accent)}
    .tag-chip small{opacity:.8}

    /* Images */
    .image-gallery{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .image-preview-item{width:110px;height:110px;border:2px solid var(--border);border-radius:10px;position:relative;cursor:pointer;overflow:hidden}
    .image-preview-item.main{border-color:var(--accent);box-shadow:0 0 10px rgba(125,211,252,0.35)}
    .image-preview-item img{width:100%;height:100%;object-fit:cover}
    .image-badge-bottom{
      position:absolute;
      bottom:6px;
      left:50%;
      transform:translateX(-50%);
      background:var(--accent);
      color:var(--bg);
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:800;
      pointer-events:none;
    }
    .image-remove{
      position:absolute;top:6px;right:6px;background:rgba(239,68,68,0.9);color:white;border:none;
      width:24px;height:24px;border-radius:7px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center
    }

    /* Modals */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1000;overflow:auto;padding:24px}
    .modal-content{background:var(--panel);max-width:900px;margin:0 auto;border:1px solid var(--border);border-radius:12px;padding:18px;position:relative}
    .modal-close{position:absolute;top:14px;right:14px;background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer}
    .modal h3{margin:0 0 12px;font-size:18px;color:var(--accent)}
    .muted{color:var(--muted);font-size:12px;line-height:1.4}

    .list-row{display:grid;grid-template-columns:1.4fr 0.9fr 1fr auto;gap:8px;margin:8px 0}
    .list-row input,.list-row select{width:100%}
    .list-row.compact{grid-template-columns:1.2fr 1fr auto}
    .list-row.tags{grid-template-columns:1.2fr 1fr 1fr auto}

    @media(max-width:820px){
      .grid{grid-template-columns:1fr}
      .list-row{grid-template-columns:1fr}
      .list-row.compact{grid-template-columns:1fr}
      .list-row.tags{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üá´üá∑ G√©n√©rateur de Publications</h1>

  <div class="section">
    <div class="section-title">üì¶ Configuration Globale (Tout-en-un)</div>
    <div class="row">
      <button id="exportGlobal">üì§ Exporter Config compl√®te</button>
      <button id="importGlobal" class="secondary">üì• Importer Config</button>
      <input type="file" id="globalFileSelector" style="display:none" accept=".json">
      <button id="resetLocal" class="danger">üßπ Reset local</button>
    </div>
    <div class="hint">Export/Import inclut : templates, variables, traducteurs, tags, URL API + cl√© API (si renseign√©e).</div>
  </div>

  <div class="section">
    <div class="section-title">1. Type de publication</div>
    <div id="templateRadios" class="template-radio-group"></div>
    <div class="row">
      <button id="openTemplateManager" class="secondary">‚úèÔ∏è G√©rer les templates</button>
      <button id="duplicateTpl" class="secondary">üß¨ Dupliquer le template</button>
    </div>
  </div>

  <div class="section">
    <div class="section-title">2. Variables</div>
    <div id="varsGrid" class="grid"></div>
    <div class="row" style="margin-top:10px">
      <button id="openVarManager" class="secondary">‚ûï Ajouter Variable</button>
      <button id="openTranslatorManager" class="secondary">üë§ Traducteurs</button>
    </div>
  </div>

  <div class="section">
    <div class="section-title">3. Aper√ßu (Brut)</div>
    <div id="preview" class="preview"></div>
    <div class="row" style="margin-top:10px">
      <button id="copyPreview">üìã Copier le message</button>
    </div>
  </div>

  <div class="section" id="discordSection">
    <div class="section-title">4. Publication Discord (API)</div>

    <div id="discordDisabledMsg" class="field" style="display:none;color:var(--danger)">
      ‚ö†Ô∏è Le template actuel n'est pas compatible publication (type <strong>my</strong> ou <strong>partner</strong> requis).
    </div>

    <div id="discordEnabledFields">
      <div class="grid">
        <div class="field">
          <label>URL API Publisher</label>
          <input type="text" id="publisherApiUrl" placeholder="https://votre-api-publisher.com/api/forum-post">
        </div>
        <div class="field">
          <label>Cl√© API</label>
          <input type="password" id="publisherApiKey" placeholder="(stock√©e en local dans ton navigateur)">
        </div>
        <div class="field">
          <label for="postTitle">Titre du post</label>
          <input type="text" id="postTitle" placeholder="Ex : Traduction de XXX ‚Äì Chapitre 1">
        </div>
        <div class="field">
          <label>Template envoy√© au bot</label>
          <input type="text" id="publisherTemplateInfo" value="" disabled>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="field">
        <label>Tags Discord (selon le template)</label>
        <div id="tagContainer" class="tag-list"></div>
        <div class="row" style="margin-top:8px">
          <button id="openTagManager" class="secondary">üè∑Ô∏è G√©rer les Tags</button>
          <button id="clearActiveTags" class="secondary">üßΩ Vider la s√©lection</button>
        </div>
        <div class="hint">Les tags sont sauvegard√©s avec : nom + scope (my/partner) + tagId. On n'affiche ici que ceux compatibles avec le template courant.</div>
      </div>

      <div class="spacer"></div>

      <div class="field">
        <label>Images</label>
        <input type="file" id="publisherImage" multiple accept="image/*">
        <div id="imageGallery" class="image-gallery"></div>
        <div class="hint">Clique une image pour la d√©finir comme principale.</div>
      </div>

      <div class="row" style="margin-top:14px">
        <button id="publishToDiscord" class="success">üöÄ Publier sur Discord</button>
        <button id="savePublisherSettings" class="secondary">üíæ Sauvegarder API</button>
        <button id="clearPublisherKey" class="secondary">üßπ Effacer la cl√©</button>
      </div>
      <div id="publisherStatus" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<!-- MODAL: Templates -->
<div id="modalTemplates" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modalTemplates')">‚úï</button>
    <h3>‚úèÔ∏è G√©rer les Templates</h3>
    <div class="muted">Un template = un nom + un type (my/partner/other) + du contenu. Les variables sont au format <code>[MA_VAR]</code>.</div>
    <div id="templateManagerList" style="margin-top:12px"></div>
    <div class="row" style="margin-top:12px">
      <button id="addNewTemplateBtn">‚ûï Nouveau Template</button>
      <button id="saveTemplatesBtn" class="success">Sauvegarder</button>
    </div>
  </div>
</div>

<!-- MODAL: Add/Edit Var -->
<div id="modalVars" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modalVars')">‚úï</button>
    <h3>üß© G√©rer les variables</h3>

    <div class="hint">Ici tu peux cr√©er/supprimer des variables et choisir sur quels templates elles apparaissent.</div>

    <div id="varManagerList" style="margin-top:12px"></div>

    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">

    <h4 style="margin:0 0 8px 0">‚ûï Ajouter une variable</h4>
    <div class="grid">
      <div class="field">
        <label>Cl√© (sans crochets)</label>
        <input id="newVarKey" type="text" placeholder="Ex: DEV_NAME">
      </div>
      <div class="field">
        <label>Label</label>
        <input id="newVarLabel" type="text" placeholder="Ex: D√©veloppeur">
      </div>
    </div>

    <div class="field" style="margin-top:10px">
      <label>Afficher sur</label>
      <div id="newVarTemplates" class="row" style="gap:10px;flex-wrap:wrap"></div>
      <div class="hint" style="margin-top:6px">Astuce : tu peux aussi changer √ßa apr√®s via la liste au-dessus.</div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="addVarConfirm" class="success">Ajouter</button>
      <button onclick="closeModal('modalVars')" class="secondary">Fermer</button>
    </div>
  </div>
</div>

<!-- MODAL: Translators -->
<div id="modalTranslators" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modalTranslators')">‚úï</button>
    <h3>üë§ Traducteurs</h3>
    <div class="muted">Liste sauvegard√©e en local. Clique un nom pour remplir automatiquement une variable <code>[traductor]</code> ou <code>[MY_NAME]</code> si elles existent.</div>
    <div id="translatorManagerList" style="margin-top:12px"></div>
    <div class="row" style="margin-top:12px">
      <button id="addTranslatorBtn">‚ûï Ajouter</button>
      <button id="saveTranslatorsBtn" class="success">Sauvegarder</button>
    </div>
  </div>
</div>

<!-- MODAL: Tags -->
<div id="modalTags" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modalTags')">‚úï</button>
    <h3>üè∑Ô∏è Configurer les Tags Discord</h3>
    <div class="muted">Format : <strong>Nom</strong> + <strong>scope</strong> (my/partner) + <strong>tagId</strong>. (IDs = Snowflakes Discord)</div>
    <div id="tagManagerList" style="margin-top:12px"></div>
    <div class="row" style="margin-top:12px">
      <button id="addNewTagBtn">‚ûï Ajouter un Tag</button>
      <button id="saveTagsBtn" class="success">Sauvegarder</button>
    </div>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);

// --- STORAGE KEYS ---
const LS = {
  STATE: 'pub_gen_state_v2',
  API_URL: 'publisherApiUrl',
  API_KEY: 'publisherApiKey'};

// --- DEFAULTS ---
// NOTE: Tout est g√©rable par l'utilisateur (cr√©ation/suppression/import/export).
// Les valeurs ci-dessous ne sont qu'un √©tat initial.
const DEFAULT_STATE = {
  templates: {},
  vars: [],
  translators: [],
  // tags: [{id, name, scope, tagId}]
  tags: [],
  currentTemplateKey: null,
  selectedImages: [],
  mainImageIdx: 0,
  activeTagIds: []
};


function uid(prefix='v'){
  return prefix + '_' + Math.random().toString(36).slice(2,9) + '_' + Date.now().toString(36);
}

function migrateState(s){
  // Ensure vars have stable ids
  s.vars = Array.isArray(s.vars) ? s.vars : [];
  s.vars = s.vars.map(v => {
    const id = v.id || uid('v');
    return { id, key: v.key || '', label: v.label || v.key || 'Variable', value: v.value || '' };
  });

  // Ensure templates structure + varsAllowed uses ids
  s.templates = s.templates && typeof s.templates === 'object' ? s.templates : {};
  for(const k of Object.keys(s.templates)){
    const tpl = s.templates[k] || {};
    if(!Array.isArray(tpl.varsAllowed)){
      // Backward compatibility: if template has varsAllowedKeys, map keys -> ids; else infer from content.
      const usedKeys = extractVarKeysFromContent(String(tpl.content || ''));
      const idByKey = new Map(s.vars.map(v => [String(v.key||'').toLowerCase(), v.id]));
      tpl.varsAllowed = usedKeys.map(key => idByKey.get(String(key).toLowerCase())).filter(Boolean);
    }else{
      // Filter unknown ids
      const known = new Set(s.vars.map(v => v.id));
      tpl.varsAllowed = tpl.varsAllowed.filter(id => known.has(id));
    }
    tpl.name = tpl.name || k;
    tpl.type = tpl.type || 'other';
    tpl.content = tpl.content || '';
    s.templates[k] = tpl;
  }

  // Ensure currentTemplateKey valid
  if(!s.currentTemplateKey || !s.templates[s.currentTemplateKey]){
    s.currentTemplateKey = Object.keys(s.templates)[0] || null;
  }

  s.translators = Array.isArray(s.translators) ? s.translators : [];
  s.tags = Array.isArray(s.tags) ? s.tags : [];
  s.selectedImages = [];
  s.mainImageIdx = 0;
  s.activeTagIds = Array.isArray(s.activeTagIds) ? s.activeTagIds : [];

  // Ensure tags structure (v3): {id, name, scope, tagId}
  s.tags = Array.isArray(s.tags) ? s.tags : [];
  s.tags = s.tags.map(t => ({
    id: t.id || uid('t'),
    name: t.name || '',
    scope: (t.scope === 'partner' ? 'partner' : 'my'),
    tagId: t.tagId || ''
  }));

  return s;
}

function extractVarKeysFromContent(content){
  const matches = String(content||'').match(/\[([A-Za-z0-9_]+)\]/g) || [];
  const keys = matches.map(m => m.slice(1,-1));
  return Array.from(new Set(keys));
}

let state = migrateState(loadState());

// --- CORE ---
function init(){
  renderTemplateRadios();
  renderVars();
  loadApiSettings();
  updateDiscordUi();
  renderTagsForForum();
  renderImageGallery();
  updatePreview();
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS.STATE);
    if(!raw) return structuredClone(DEFAULT_STATE);
    const parsed = JSON.parse(raw);
    // Merge shallow + ensure required fields exist
    return {
      ...structuredClone(DEFAULT_STATE),
      ...parsed,
      templates: { ...structuredClone(DEFAULT_STATE.templates), ...(parsed.templates || {}) },
      vars: Array.isArray(parsed.vars) ? parsed.vars : structuredClone(DEFAULT_STATE.vars),
      translators: Array.isArray(parsed.translators) ? parsed.translators : [],
      tags: Array.isArray(parsed.tags) ? parsed.tags : [],
      selectedImages: [] // images never persisted
    };
  }catch(e){
    return structuredClone(DEFAULT_STATE);
  }
}

function saveState(){
  // Never store File objects
  const safe = { ...state, selectedImages: [], mainImageIdx: 0 };
  localStorage.setItem(LS.STATE, JSON.stringify(safe));
}

function currentTemplate(){
  return state.templates[state.currentTemplateKey] || null;
}

function isPublishableTemplate(tpl){
  return tpl && (tpl.type === 'my' || tpl.type === 'partner');
}

function updatePreview(){
  const tpl = currentTemplate();
  if(!tpl){
    $('preview').textContent = '‚ö†Ô∏è Aucun template.';
    return;
  }

  let output = String(tpl.content || '');

  // Replace vars
  state.vars.forEach(v => {
    const key = String(v.key || '').trim();
    if(!key) return;
    const val = (v.value ?? '').toString();
    const rx = new RegExp('\\[' + escapeRegExp(key) + '\\]', 'g');
    output = output.replace(rx, val.trim() ? val : `[${key}]`);
  });

  $('preview').textContent = output;
}

function updateDiscordUi(){
  const tpl = currentTemplate();
  const canPublish = isPublishableTemplate(tpl);

  // Show/hide entire section content
  $('discordEnabledFields').style.display = canPublish ? 'block' : 'none';
  $('discordDisabledMsg').style.display = canPublish ? 'none' : 'block';
  $('discordSection').classList.toggle('disabled', !canPublish);

  // Template envoy√© au bot:
  // - Si l'utilisateur n'a pas les templates correspondants => on cache le champ (et on n'affiche pas la section)
  // Ici: si non publishable => section d√©sactiv√©e + champ inutile => on ne le montre pas (en m√™me temps que fields)
  if(canPublish){
    $('publisherTemplateInfo').value = `${tpl.name} (${tpl.type})`;
    // Nettoyer les tags actifs selon le scope (my/partner)
    const scope = currentTagScope();
    const allowed = new Set(tagsForScope(scope).map(t => String(t.tagId||'').trim()).filter(Boolean));
    state.activeTagIds = state.activeTagIds.filter(id => allowed.has(String(id).trim()));
    saveState();
  }else{
    $('publisherTemplateInfo').value = '';
    // Template non publiable => pas de tags actifs
    state.activeTagIds = [];
    saveState();
  }

  // Refresh tags list when template changes (scope my/partner)
  renderTagsForForum();
}

function escapeRegExp(str){
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// --- RENDER: Templates ---
function renderTemplateRadios(){
  const root = $('templateRadios');
  root.innerHTML = '';

  Object.keys(state.templates).forEach(key => {
    const t = state.templates[key];
    const wrap = document.createElement('div');
    wrap.className = 'template-radio-item';
    wrap.innerHTML = `
      <input type="radio" name="tpl" id="tpl_${key}">
      <label class="template-radio-label" for="tpl_${key}">${escapeHtml(t?.name || key)}</label>
    `;
    const input = wrap.querySelector('input');
    input.checked = state.currentTemplateKey === key;
    input.addEventListener('change', ()=>{
      state.currentTemplateKey = key;
      saveState();
      updateDiscordUi();
      updatePreview();
    });
    root.appendChild(wrap);
  });
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

// --- RENDER: Vars ---
function getVisibleVarsForTemplate(templateKey){
  const tpl = state.templates?.[templateKey];
  if(!tpl) return [];
  const allowed = new Set(Array.isArray(tpl.varsAllowed) ? tpl.varsAllowed : []);
  return state.vars.filter(v => allowed.has(v.id));
}

function renderVars(){
  const grid = $('varsGrid');
  grid.innerHTML = '';
  const tplKey = state.currentTemplateKey;
  const visible = getVisibleVarsForTemplate(tplKey);

  if(!tplKey){
    grid.innerHTML = '<div class="hint">Aucun template s√©lectionn√©.</div>';
    return;
  }
  if(visible.length === 0){
    grid.innerHTML = '<div class="hint">Aucune variable affich√©e pour ce template. Utilise ‚ÄúG√©rer les variables‚Äù pour en ajouter.</div>';
    return;
  }

  visible.forEach((v)=>{
    const div = document.createElement('div');
    div.className = 'field';
    div.innerHTML = `
      <label>${escapeHtml(v.label || v.key || 'Variable')} <span class="pill">[${escapeHtml(v.key || '')}]</span></label>
      <input type="text" value="${escapeHtml(v.value || '')}" placeholder="[${escapeHtml(v.key || '')}]">
    `;
    const input = div.querySelector('input');
    input.addEventListener('input', ()=>{
      const idx = state.vars.findIndex(x => x.id === v.id);
      if(idx !== -1) state.vars[idx].value = input.value;
      saveState();
      updatePreview();
    });
    grid.appendChild(div);
  });
}

// --- TAGS ---
function currentTagScope(){
  const tpl = state.currentTemplateKey ? state.templates[state.currentTemplateKey] : null;
  const t = tpl && String(tpl.type || '').trim();
  return (t === 'my' || t === 'partner') ? t : '';
}

function tagsForScope(scope){
  const s = String(scope || '').trim();
  if(!s) return [];
  return state.tags.filter(t => String(t.scope || '').trim() === s);
}

function renderTagsForForum(){
  const container = $('tagContainer');
  container.innerHTML = '';

  const scope = currentTagScope();
  const list = tagsForScope(scope);

  if(!scope){
    container.innerHTML = `<span class="muted">S√©lectionne un template publiable (type my/partner) pour g√©rer les tags.</span>`;
    return;
  }
  if(list.length === 0){
    container.innerHTML = `<span class="muted">Aucun tag sauvegard√© pour scope: ${escapeHtml(scope)}.</span>`;
    return;
  }
list.forEach(tag=>{
    const tagId = String(tag.tagId || '').trim();
    const isActive = state.activeTagIds.includes(tagId);
    const chip = document.createElement('div');
    chip.className = `tag-chip ${isActive ? 'active' : ''}`;
    chip.innerHTML = `${escapeHtml(tag.name || 'Tag')} <small>(${escapeHtml(tagId)})</small>`;
    chip.addEventListener('click', ()=>{
      if(isActive){
        state.activeTagIds = state.activeTagIds.filter(id => id !== tagId);
      }else{
        state.activeTagIds.push(tagId);
      }
      saveState();
      renderTagsForForum();
    });
    container.appendChild(chip);
  });
}

// --- IMAGES ---
function renderImageGallery(){
  const root = $('imageGallery');
  root.innerHTML = '';

  state.selectedImages.forEach((img, idx)=>{
    const div = document.createElement('div');
    div.className = `image-preview-item ${state.mainImageIdx === idx ? 'main' : ''}`;

    div.innerHTML = `
      <img src="${img.preview}" alt="">
      <button class="image-remove" title="Retirer">‚úï</button>
      ${
        state.mainImageIdx === idx
          ? `<div class="image-badge-bottom">PRINCIPALE</div>`
          : ``
      }
    `;

    // clic image = d√©finir comme principale
    div.addEventListener('click', (e)=>{
      if(e.target.classList.contains('image-remove')) return;
      state.mainImageIdx = idx;
      renderImageGallery();
    });

    // suppression image
    div.querySelector('.image-remove').addEventListener('click', (e)=>{
      e.stopPropagation();
      state.selectedImages.splice(idx, 1);
      if(state.mainImageIdx >= state.selectedImages.length){
        state.mainImageIdx = Math.max(0, state.selectedImages.length - 1);
      }
      renderImageGallery();
    });

    root.appendChild(div);
  });
}

// --- PUBLISHER SETTINGS ---
function loadApiSettings(){
  $('publisherApiUrl').value = localStorage.getItem(LS.API_URL) || '';
  $('publisherApiKey').value = localStorage.getItem(LS.API_KEY) || '';
}

function saveApiSettings(){
  localStorage.setItem(LS.API_URL, $('publisherApiUrl').value.trim());
  localStorage.setItem(LS.API_KEY, $('publisherApiKey').value);
}

function clearApiKey(){
  if(!confirm('Effacer la cl√© API enregistr√©e ?')) return;
  localStorage.removeItem(LS.API_KEY);
  $('publisherApiKey').value = '';
}

// --- PUBLISH ---
async function publishToDiscord(){
  const tpl = currentTemplate();
  const status = $('publisherStatus');
  status.textContent = '';

  if(!isPublishableTemplate(tpl)){
    status.textContent = "‚ùå Le template actuel n'est pas publiable.";
    return;
  }

  const apiUrl   = $('publisherApiUrl')?.value?.trim() || '';
  const apiKey   = $('publisherApiKey')?.value?.trim() || '';
  const postTitle = $('postTitle')?.value?.trim() || '';

  if(!apiUrl){
    status.textContent = "‚ùå Renseigne l'URL de l'API Publisher.";
    return;
  }
  if(!postTitle){
    status.textContent = "‚ùå Renseigne le titre du post.";
    return;
  }
  if(!apiKey){
    status.textContent = "‚ùå Renseigne la cl√© API.";
    return;
  }

  // Scope = my/partner (tpl.type)
  const scope = tpl.type;

  // Tags compatibles avec ce scope, envoy√©s en "id1,id2,id3"
  const allowed = new Set(
    tagsForScope(scope)
      .map(t => String(t.tagId || '').trim())
      .filter(Boolean)
  );
  const active = (state.activeTagIds || [])
    .map(x => String(x).trim())
    .filter(x => allowed.has(x));

  const tagsCsv = active.join(',');

  const btn = $('publishToDiscord');
  const oldText = btn?.textContent || 'Publier';
  if(btn){
    btn.disabled = true;
    btn.textContent = '‚è≥ Publication...';
  }

  try{
    const fd = new FormData();

    // Champs attendus par publisher_api.py
    fd.append('title', postTitle);
    fd.append('content', $('preview')?.textContent || ' ');
    fd.append('tags', tagsCsv);
    fd.append('template', scope); // IMPORTANT: "template" (my/partner), pas "type"

    // Une seule image attendue: part.name == "image"
    // On prend l'image principale si elle existe, sinon la 1√®re.
    const imgs = state.selectedImages || [];
    const mainIdx = Number.isFinite(state.mainImageIdx) ? state.mainImageIdx : 0;
    const pick = imgs[mainIdx] || imgs[0];

    if(pick && pick.file){
      fd.append('image', pick.file, pick.file.name);
    }

    const res = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'X-API-KEY': apiKey, // IMPORTANT: le backend lit ici
      },
      body: fd
    });

    const data = await res.json().catch(()=>null);

    if(!res.ok || !data || !data.ok){
      const err =
        (data && (data.error || data.message))
          ? (data.error || data.message)
          : ('HTTP ' + res.status);
      status.textContent = '‚ùå √âchec : ' + err;
      return;
    }

    try{ localStorage.setItem('lastPostTitle', postTitle); }catch(e){}

    if(data.thread_url){
      const safeUrl = String(data.thread_url);
      status.innerHTML = `‚úÖ Succ√®s ! <a href="${safeUrl}" target="_blank" rel="noopener" style="color:var(--accent)">Voir le post</a>`;
    }else{
      status.textContent = '‚úÖ Succ√®s !';
    }

  }catch(e){
    status.textContent = '‚ùå Erreur r√©seau.';
  }finally{
    if(btn){
      btn.disabled = false;
      btn.textContent = oldText;
    }
  }
}

// --- GLOBAL IMPORT/EXPORT ---
function exportGlobalConfig(){
  const fullConfig = {
    version: 3,
    exportedAt: new Date().toISOString(),
    state: { ...state, selectedImages: [], mainImageIdx: 0 },
    apiSettings: {
      url: $('publisherApiUrl').value.trim(),
      key: $('publisherApiKey').value,
    }
  };
  const blob = new Blob([JSON.stringify(fullConfig, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `config_generateur_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importGlobalConfig(file){
  const reader = new FileReader();
  reader.onload = (event)=>{
    try{
      const imported = JSON.parse(event.target.result);

      // Support: allow direct state object too
      const incomingState = imported.state ? imported.state : imported;

      if(incomingState && typeof incomingState === 'object'){
        state = {
          ...structuredClone(DEFAULT_STATE),
          ...incomingState,
          templates: { ...structuredClone(DEFAULT_STATE.templates), ...(incomingState.templates || {}) },
          vars: Array.isArray(incomingState.vars) ? incomingState.vars : structuredClone(DEFAULT_STATE.vars),
          translators: Array.isArray(incomingState.translators) ? incomingState.translators : [],
          tags: Array.isArray(incomingState.tags) ? incomingState.tags : [],
          selectedImages: [],
          mainImageIdx: 0
        };

        if(imported.apiSettings){
          $('publisherApiUrl').value = imported.apiSettings.url || '';
          $('publisherApiKey').value = imported.apiSettings.key || '';
        }
        saveState();
        saveApiSettings();
        init();
        alert('‚úÖ Configuration import√©e !');
      }else{
        alert('‚ùå Fichier JSON invalide.');
      }
    }catch(e){
      alert('‚ùå Fichier JSON invalide.');
    }
  };
  reader.readAsText(file);
}

function resetLocal(){
  if(!confirm('Tout effacer en local (config + API) ?')) return;
  localStorage.removeItem(LS.STATE);
  localStorage.removeItem(LS.API_URL);
  localStorage.removeItem(LS.API_KEY);
  state = structuredClone(DEFAULT_STATE);
  loadApiSettings();
  saveState();
  init();
  alert('‚úÖ Reset effectu√©.');
}

// --- MODALS ---
function closeModal(id){ $(id).style.display = 'none'; }
function openModal(id){ $(id).style.display = 'block'; }

// Templates modal
function renderTemplateManager(){
  const root = $('templateManagerList');
  root.innerHTML = '';
  Object.keys(state.templates).forEach((key)=>{
    const t = state.templates[key];
    const row = document.createElement('div');
    row.className = 'list-row';
    row.innerHTML = `
      <input type="text" placeholder="Nom" value="${escapeHtml(t?.name || '')}">
      <select>
        <option value="my">my</option>
        <option value="partner">partner</option>
        <option value="other">other</option>
      </select>
      <input type="text" placeholder="Cl√© interne (unique)" value="${escapeHtml(key)}" disabled>
      <button class="danger" title="Supprimer">üóëÔ∏è</button>

      <div style="grid-column:1/-1" class="field">
        <label>Contenu</label>
        <textarea style="width:100%"></textarea>
      </div>
    `;
    const inputs = row.querySelectorAll('input');
    const nameInput = inputs[0];
    const keyInput = inputs[1]; // disabled key
    const typeSelect = row.querySelector('select');
    const ta = row.querySelector('textarea');
    const del = row.querySelector('button.danger');

    typeSelect.value = (t && t.type) ? t.type : 'other';
    ta.value = t?.content || '';

    nameInput.addEventListener('input', ()=>{ state.templates[key].name = nameInput.value; });
    typeSelect.addEventListener('change', ()=>{ state.templates[key].type = typeSelect.value; });
    ta.addEventListener('input', ()=>{ state.templates[key].content = ta.value; });

    del.addEventListener('click', ()=>{
      if(!confirm(`Supprimer "${t?.name || key}" ?`)) return;
      delete state.templates[key];
      if(state.currentTemplateKey === key){
        state.currentTemplateKey = Object.keys(state.templates)[0] || 'my';
      }
      renderTemplateManager();
    });

    root.appendChild(row);
  });
}

function addNewTemplate(){
  const base = 'nouveau_template';
  let key = base;
  let i = 1;
  while(state.templates[key]){ key = base + '_' + i; i++; }
  state.templates[key] = { name:'Nouveau Template', type:'other', content:'## [NAME_GAME]\n\n[DESC_GAME]' };
  state.currentTemplateKey = key;
  renderTemplateManager();
}

// Vars modal
function addVar(){
  const key = ($('newVarKey').value || '').trim();
  const label = ($('newVarLabel').value || '').trim();
  if(!key || !label){
    alert('Renseigne la cl√© et le label.');
    return;
  }
  if(state.vars.some(v => (v.key || '').toLowerCase() === key.toLowerCase())){
    alert('Cette variable existe d√©j√†.');
    return;
  }

  const id = uid('v');
  const v = { id, key, label, value: '' };
  state.vars.push(v);

  // Apply to selected templates
  const checks = document.querySelectorAll('#newVarTemplates input[type="checkbox"][data-template]');
  const selected = Array.from(checks).filter(c => c.checked).map(c => c.getAttribute('data-template'));
  selected.forEach(tk => {
    const tpl = state.templates[tk];
    if(!tpl) return;
    tpl.varsAllowed = Array.isArray(tpl.varsAllowed) ? tpl.varsAllowed : [];
    if(!tpl.varsAllowed.includes(id)) tpl.varsAllowed.push(id);
  });

  saveState();
  renderVars();
  updatePreview();
  renderVarManager();
  $('newVarKey').value = '';
  $('newVarLabel').value = '';
  // reset checks
  document.querySelectorAll('#newVarTemplates input[type="checkbox"][data-template]').forEach(c => c.checked = false);
}

function deleteVar(varId){
  const v = state.vars.find(x => x.id === varId);
  if(!v) return;
  if(!confirm(`Supprimer la variable ${v.key} ?`)) return;

  // Remove from vars
  state.vars = state.vars.filter(x => x.id !== varId);

  // Remove from templates
  for(const tk of Object.keys(state.templates)){
    const tpl = state.templates[tk];
    tpl.varsAllowed = (tpl.varsAllowed || []).filter(id => id !== varId);
  }

  // If current template has now zero vars, keep it as-is (UI will show hint)
  saveState();
  renderVars();
  updatePreview();
  renderVarManager();
}

function setVarAllowedOnTemplate(varId, templateKey, allowed){
  const tpl = state.templates?.[templateKey];
  if(!tpl) return;
  tpl.varsAllowed = Array.isArray(tpl.varsAllowed) ? tpl.varsAllowed : [];
  const set = new Set(tpl.varsAllowed);
  allowed ? set.add(varId) : set.delete(varId);
  tpl.varsAllowed = [...set];
  saveState();
  renderVars();
  updatePreview();
}

function renderVarManager(){
  const host = $('varManagerList');
  if(!host) return;
  host.innerHTML = '';

  const templateKeys = Object.keys(state.templates || {});
  if(state.vars.length === 0){
    host.innerHTML = '<div class="hint">Aucune variable. Ajoute-en une ci-dessous.</div>';
    return;
  }

  state.vars.forEach(v => {
    const row = document.createElement('div');
    row.className = 'card';
    row.style.padding = '10px';
    row.style.marginBottom = '10px';
    row.innerHTML = `
      <div class="row" style="gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div class="field" style="flex:1;min-width:180px">
          <label>Cl√©</label>
          <input type="text" value="${escapeHtml(v.key || '')}" data-k="key">
        </div>
        <div class="field" style="flex:1;min-width:220px">
          <label>Label</label>
          <input type="text" value="${escapeHtml(v.label || '')}" data-k="label">
        </div>
        <div class="field" style="flex:1;min-width:220px">
          <label>Valeur</label>
          <input type="text" value="${escapeHtml(v.value || '')}" data-k="value">
        </div>
        <button class="danger" data-action="del">Supprimer</button>
      </div>
      <div style="margin-top:8px">
        <div class="hint" style="margin:0 0 6px 0">Afficher sur :</div>
        <div class="row" style="gap:10px;flex-wrap:wrap" data-templates></div>
      </div>
    `;

    // Bind edits
    row.querySelectorAll('input[data-k]').forEach(inp => {
      inp.addEventListener('input', ()=>{
        const idx = state.vars.findIndex(x => x.id === v.id);
        if(idx === -1) return;
        const k = inp.getAttribute('data-k');
        state.vars[idx][k] = inp.value;
        saveState();
        renderVars();
        updatePreview();
      });
    });

    // Delete
    row.querySelector('[data-action="del"]').addEventListener('click', ()=> deleteVar(v.id));

    // Template checkboxes
    const tplBox = row.querySelector('[data-templates]');
    templateKeys.forEach(tk => {
      const tpl = state.templates[tk];
      const checked = (tpl.varsAllowed || []).includes(v.id);
      const label = document.createElement('label');
      label.className = 'check';
      label.style.display = 'inline-flex';
      label.style.alignItems = 'center';
      label.style.gap = '6px';
      label.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''}> <span>${escapeHtml(tpl?.name || tk)}</span>`;
      const cb = label.querySelector('input');
      cb.addEventListener('change', ()=> setVarAllowedOnTemplate(v.id, tk, cb.checked));
      tplBox.appendChild(label);
    });

    host.appendChild(row);
  });
}


// Translators modal
function renderTranslatorManager(){
  const root = $('translatorManagerList');
  root.innerHTML = '';
  if(state.translators.length === 0){
    root.innerHTML = '<div class="muted">Aucun traducteur sauvegard√©.</div>';
    return;
  }
  state.translators.forEach((name, idx)=>{
    const row = document.createElement('div');
    row.className = 'list-row compact';
    row.innerHTML = `
      <input type="text" value="${escapeHtml(name)}">
      <button class="secondary">‚§µÔ∏è Utiliser</button>
      <button class="danger">üóëÔ∏è</button>
    `;
    const input = row.querySelector('input');
    const useBtn = row.querySelector('button.secondary');
    const del = row.querySelector('button.danger');

    input.addEventListener('input', ()=>{ state.translators[idx] = input.value; });

    useBtn.addEventListener('click', ()=>{
      const val = input.value.trim();
      if(!val) return;
      // Fill best-effort variables
      const v1 = state.vars.find(v => (v.key||'') === 'traductor');
      const v2 = state.vars.find(v => (v.key||'') === 'MY_NAME');
      if(v1) v1.value = val;
      else if(v2) v2.value = val;
      saveState();
      renderVars();
      updatePreview();
      closeModal('modalTranslators');
    });

    del.addEventListener('click', ()=>{
      if(!confirm('Supprimer ce traducteur ?')) return;
      state.translators.splice(idx,1);
      renderTranslatorManager();
    });

    root.appendChild(row);
  });
}

function addTranslator(){
  state.translators.push('Nouveau traducteur');
  renderTranslatorManager();
}

// Tags modal
function renderTagManager(){
  const root = $('tagManagerList');
  root.innerHTML = '';
  if(state.tags.length === 0){
    root.innerHTML = '<div class="muted">Aucun tag sauvegard√©.</div>';
  }
  state.tags.forEach((tag, idx)=>{
    const row = document.createElement('div');
    row.className = 'list-row tags';
    row.innerHTML = `
      <input type="text" placeholder="Nom" value="${escapeHtml(tag.name || '')}">
      <select title="scope">
        <option value="my" ${String(tag.scope||'')==='my'?'selected':''}>my</option>
        <option value="partner" ${String(tag.scope||'')==='partner'?'selected':''}>partner</option>
      </select>
      <input type="text" placeholder="tagId" value="${escapeHtml(tag.tagId || '')}">
      <button class="danger" title="Supprimer">üóëÔ∏è</button>
    `;
    const nameI = row.querySelectorAll('input')[0];
    const scopeS = row.querySelector('select');
    const tagI = row.querySelectorAll('input')[1];
    const del = row.querySelector('button.danger');

    nameI.addEventListener('input', ()=>{ state.tags[idx].name = nameI.value; });
    scopeS.addEventListener('change', ()=>{ state.tags[idx].scope = forumI.value; });
    tagI.addEventListener('input', ()=>{ state.tags[idx].tagId = tagI.value; });

    del.addEventListener('click', ()=>{
      if(!confirm('Supprimer ce tag ?')) return;
      state.tags.splice(idx,1);
      renderTagManager();
    });

    root.appendChild(row);
  });
}

function addNewTag(){
  state.tags.push({ id: uid('t'), name:'Nouveau Tag', scope: currentTagScope() || 'my', tagId:'' });
  renderTagManager();
}

// --- EVENTS ---
$('copyPreview').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText($('preview').textContent);
    $('copyPreview').textContent = '‚úÖ Copi√© !';
    setTimeout(()=> $('copyPreview').textContent = 'üìã Copier le message', 1100);
  }catch(e){
    alert('Erreur copie.');
  }
});

$('publisherImage').addEventListener('change', (e)=>{
  const files = Array.from(e.target.files || []);
  files.forEach(file=>{
    if(!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      state.selectedImages.push({ file, preview: ev.target.result });
      if(state.selectedImages.length === 1) state.mainImageIdx = 0;
      renderImageGallery();
    };
    reader.readAsDataURL(file);
  });
  // reset input (allow selecting same file again)
  e.target.value = '';
});


$('savePublisherSettings').addEventListener('click', ()=>{
  saveApiSettings();
  $('savePublisherSettings').textContent = '‚úÖ Sauvegard√© !';
  setTimeout(()=> $('savePublisherSettings').textContent = 'üíæ Sauvegarder API', 1200);
});

$('clearPublisherKey').addEventListener('click', clearApiKey);

$('publishToDiscord').addEventListener('click', ()=>{
  saveApiSettings();
  publishToDiscord();
});

$('clearActiveTags').addEventListener('click', ()=>{
  state.activeTagIds = [];
  saveState();
  renderTagsForForum();
});

// Global import/export
$('exportGlobal').addEventListener('click', exportGlobalConfig);
$('importGlobal').addEventListener('click', ()=> $('globalFileSelector').click());
$('globalFileSelector').addEventListener('change', (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  importGlobalConfig(file);
  e.target.value = '';
});
$('resetLocal').addEventListener('click', resetLocal);

// Open modals
$('openTemplateManager').addEventListener('click', ()=>{
  renderTemplateManager();
  openModal('modalTemplates');
});
$('addNewTemplateBtn').addEventListener('click', addNewTemplate);
$('saveTemplatesBtn').addEventListener('click', ()=>{
  saveState();
  renderTemplateRadios();
  updateDiscordUi();
  updatePreview();
  closeModal('modalTemplates');
});

$('duplicateTpl').addEventListener('click', ()=>{
  const tpl = currentTemplate();
  if(!tpl) return;
  const base = (tpl.name || 'template').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  let key = base || 'template';
  let i = 1;
  while(state.templates[key]){ key = (base || 'template') + '_' + i; i++; }
  state.templates[key] = { name: (tpl.name || 'Template') + ' (copie)', type: tpl.type || 'other', content: tpl.content || '' };
  state.currentTemplateKey = key;
  saveState();
  renderTemplateRadios();
  updateDiscordUi();
  updatePreview();
});

$('openVarManager').addEventListener('click', ()=>{
  // Build template checklist for "add variable"
  const host = $('newVarTemplates');
  host.innerHTML = '';
  Object.keys(state.templates || {}).forEach(tk => {
    const tpl = state.templates[tk];
    const label = document.createElement('label');
    label.className = 'check';
    label.style.display = 'inline-flex';
    label.style.alignItems = 'center';
    label.style.gap = '6px';
    label.innerHTML = `<input type="checkbox" data-template="${escapeHtml(tk)}"> <span>${escapeHtml(tpl?.name || tk)}</span>`;
    host.appendChild(label);
  });

  $('newVarKey').value = '';
  $('newVarLabel').value = '';
  renderVarManager();
  openModal('modalVars');
});
$('addVarConfirm').addEventListener('click', addVar);

$('openTranslatorManager').addEventListener('click', ()=>{
  renderTranslatorManager();
  openModal('modalTranslators');
});
$('addTranslatorBtn').addEventListener('click', addTranslator);
$('saveTranslatorsBtn').addEventListener('click', ()=>{
  // sanitize
  state.translators = state.translators.map(s => String(s||'').trim()).filter(Boolean);
  saveState();
  closeModal('modalTranslators');
});

$('openTagManager').addEventListener('click', ()=>{
  renderTagManager();
  openModal('modalTags');
});
$('addNewTagBtn').addEventListener('click', addNewTag);
$('saveTagsBtn').addEventListener('click', ()=>{
  // sanitize tags
  state.tags = state.tags
    .map(t => ({ name:String(t.name||'').trim(), scope:String(t.scope||'my').trim(), tagId:String(t.tagId||'').trim() }))
    .filter(t => t.name && t.scope && t.tagId);
  saveState();
  // keep only allowed active tags
  const allowed = new Set(tagsForScope(currentTagScope()).map(t => String(t.tagId||'').trim()).filter(Boolean));
  state.activeTagIds = state.activeTagIds.filter(id => allowed.has(String(id).trim()));
  saveState();
  renderTagsForForum();
  closeModal('modalTags');
});

// Close modals on outside click
['modalTemplates','modalVars','modalTranslators','modalTags'].forEach(id=>{
  $(id).addEventListener('click', (e)=>{
    if(e.target === $(id)) closeModal(id);
  });
});

// Kickoff
init();
</script>
</body>
</html>
