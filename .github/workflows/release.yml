name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

env:
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

jobs:
  build-release:
    name: Build and Release
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: |
          npm ci
          cd frontend && npm ci

      - name: Create .env file with Supabase credentials
        shell: pwsh
        run: |
          $envContent = @"
          VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          "@
          $envContent | Out-File -FilePath "frontend/.env" -Encoding utf8
          Write-Host "‚úÖ .env file created with Supabase credentials"

      - name: Build application
        run: npm run build

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version extracted: $version"

      - name: Create portable version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $exePath = "src-tauri\target\release\app.exe"
          $portableName = "Discord_Publisher_${version}_portable.exe"
          
          if (Test-Path $exePath) {
            Copy-Item $exePath $portableName
            Write-Host "‚úÖ Portable version created: $portableName"
          } else {
            Write-Host "‚ö†Ô∏è exe not found at $exePath"
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.nsis.zip
            src-tauri/target/release/bundle/nsis/*.nsis.zip.sig
            Discord_Publisher_*_portable.exe
          name: Discord Publisher v${{ steps.version.outputs.VERSION }}
          body: |
            ## üéâ Nouvelle version : ${{ steps.version.outputs.VERSION }}
            
            ### üì¶ Installation
            
            1. **T√©l√©charger** l'installateur Windows ci-dessous
            2. **Ex√©cuter** le fichier `.exe` et suivre les instructions
            3. **Lancer** l'application depuis le menu D√©marrer
            
            ### üîÑ Mise √† jour automatique
            
            Si vous avez d√©j√† Discord Publisher install√© :
            - L'application d√©tectera automatiquement cette nouvelle version
            - Une notification vous proposera de mettre √† jour
            - Cliquez sur "Installer" pour t√©l√©charger et installer
            
            ### üìù Changelog
            
            *Voir les commits depuis la derni√®re release pour les d√©tails.*
            
            ---
            
            **Build date** : ${{ github.event.head_commit.timestamp }}  
            **Commit** : ${{ github.sha }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Discord Notification
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: pwsh
        run: |
          if (-not $env:DISCORD_WEBHOOK_URL) {
            Write-Host "Discord webhook not configured, skipping notification"
            exit 0
          }
          
          $version = "${{ steps.version.outputs.VERSION }}"
          $releaseUrl = "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          
          $payload = @{
            embeds = @(@{
              title = "üöÄ Nouvelle version disponible !"
              description = "Discord Publisher v$version vient d'√™tre publi√©"
              color = 5814783
              fields = @(
                @{
                  name = "Version"
                  value = "``$version``"
                  inline = $true
                },
                @{
                  name = "Plateforme"
                  value = "Windows (NSIS)"
                  inline = $true
                },
                @{
                  name = "Build"
                  value = "Succ√®s ‚úÖ"
                  inline = $true
                }
              )
              url = $releaseUrl
              timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
              footer = @{
                text = "GitHub Actions"
              }
            })
          } | ConvertTo-Json -Depth 10
          
          try {
            Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK_URL -Method Post -Body $payload -ContentType "application/json"
            Write-Host "Discord notification sent successfully"
          } catch {
            Write-Host "Failed to send Discord notification: $_"
            # Don't fail the workflow if notification fails
            exit 0
          }

      - name: Notify build failure to Discord
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: pwsh
        run: |
          if (-not $env:DISCORD_WEBHOOK_URL) {
            exit 0
          }
          
          $version = "${{ steps.version.outputs.VERSION }}"
          $workflowUrl = "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          $payload = @{
            embeds = @(@{
              title = "‚ùå Build √©chou√©"
              description = "Le build de Discord Publisher v$version a √©chou√©"
              color = 15158332
              fields = @(
                @{
                  name = "Version"
                  value = "``$version``"
                  inline = $true
                },
                @{
                  name = "Build"
                  value = "√âchec ‚ùå"
                  inline = $true
                }
              )
              url = $workflowUrl
              timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
              footer = @{
                text = "GitHub Actions"
              }
            })
          } | ConvertTo-Json -Depth 10
          
          try {
            Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK_URL -Method Post -Body $payload -ContentType "application/json"
          } catch {
            exit 0
          }
